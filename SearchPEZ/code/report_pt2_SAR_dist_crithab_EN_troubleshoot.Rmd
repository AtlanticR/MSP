---
title: "Reproducible Report for Species in Maritimes Region - for Internal DFO use only"
author: Synthesis prepared by the Reproducible Reporting Team, steering committee and advisors.
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    theme: paper
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---
```{r load packages, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
library(Mar.datawrangling)
#library(Mar.utils)
library(knitr)
library(kableExtra)
library(rgdal)
library(maps)
library(lubridate)
library(raster)
library(RCurl)
library(sf)
library(stringr)
library(ggplot2)
library(data.table)
library(gridExtra)
library(dplyr)
library(stars)
library(ggspatial)
library(tidyverse)
#These next two lines are necessary for the generation of the water mark on all plots.
#install.packages("remotes")
#remotes::install_github("terminological/standard-print-output")
library(standardPrintOutput)
```

```{r source functions, include=FALSE, cache=FALSE}
# the .Rmd file sets the working directory based on where it resides and ignores the wd set by the .RProj file
source("site_map.r")
source("site_map_new.r")
source("filter_wsdb.r")
source("filter_narwc_new.r")
# ## Another option is to load directly from the web and read in using Rcurl
#function_urls <- c("https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/site_map.r",
#                    "https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/plot_wsdb.r",
#                    "https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/filter_wsdb.r")
#for (i in function_urls){eval(parse(text = RCurl::getURL(i, ssl.verifypeer = FALSE)),envir=.GlobalEnv)}
source("EBSA.R")
source("leatherback.R")
source("cetacean_priority_areas.R")
source("Blue_Whale_habitat.R")
source("fn_SearchRVData.r")
source("fn_Search_ISDB_Data.r")
source("fn_maps.r")
source("fn_Search_MARFIS_Data.r")
```

```{r Define Site, include=FALSE, cache=FALSE}
#HTML output of code is automatically generated in Catalina's computer: RProjects/MSP/SearchPEZ/code
#output of get.data.R should be manually moved to RProjects/MSP/SearchPEZ/outputs/sitenamexkm  
#AquaSiteName <- "TestGully"
#PEZversion <- "Polygon"
AquaSiteName <- "FarmersLedge"
PEZversion <- "4748m"
UserComments <- "Example - First search effort for suitability of a site for a project planned for 2025. Project is expected to have positive/negative impacts on surrounding area. It is likely that some kind of monitoring will be required during operations. Make sure to follow up on all sections pertaining to a particular taxonomic group as this seems to be a concern of the stakeholders."
#make sure you delete all shp.xml files in the folder to be able to run this code
minYear <- 1970
maxYear <- 2020
```

```{r Set up paths, include=FALSE, cache=FALSE}
mspPath <- "../"
data.dir = "../../../Data/mar.wrangling"
#create a folder in outputs with the name of the site and buffer area search
dataPath <- file.path("../../../Data/outputs",paste0(AquaSiteName,PEZversion))
# setwd(dataPath) #not needed?
polyPath <- "../../../Data/Zones/SearchPEZpolygons"
site <- readOGR(polyPath,layer=paste0("Site_",AquaSiteName))
site_sf <- st_as_sf(site)
#landGDB <- "../../../Data/Boundaries/Coast50K/Coastline50k.gdb"
#land <- readOGR(dsn=landGDB,layer="Land50k_Maritimes",stringsAsFactors=F)
#land_sf <- st_as_sf(land)
land_sf<-st_read("../../../Data/Boundaries/Coast50K/Coastline50k_SHP/Land_AtlCanada_ESeaboardUS.shp", quiet=TRUE)
pl <- list.files(polyPath,"*.shp")
pl <- pl[-grep("xml",pl)]
PEZ_poly <- readOGR(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]))
#PEZ_poly_st<-st_read(../../../Data/Zones/SearchPEZpolygons/PEZ_TestGullyPolygon.shp", quiet=TRUE)
PEZ_poly_st<-st_as_sf(PEZ_poly)
#load data sets that are used in multiple sections
obis<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/OBIS_MAR_priority_records.csv")
obis<-subset(obis,year>minYear,year<maxYear)
#FFHPP_shp <- st_read("../../../Data/Infrastructure/FFHPP_Referrals/FFHPP_Referrals_0620.shp", quiet=TRUE)
```

```{r Species listed by Wildspecies, COSEWIC and SARA in the Maritime Region, include=FALSE, cache=FALSE}
listed_species<-read.csv("../../../Data/NaturalResources/Species/MAR_listed_species.csv")
cetacean_list<-c("Beluga Whale", "Humpback Whale" , "North Atlantic Right Whale", "Fin Whale", "Northern Bottlenose Whale", 
                            "Harbour Porpoise", "Killer Whale", "Blue Whale", "Sei Whale", "Sowerby's Beaked Whale")
other_species_list<-c("Loggerhead Sea Turtle", "Atlantic Walrus", "Harbour Seal Lacs des Loups Marins subspecies", "Leatherback Sea Turtle")
listed_cetacean_species<-subset(listed_species, Common_Name %in% cetacean_list)
listed_other_species<-subset(listed_species, Common_Name %in% other_species_list)
listed_fish_invert_species<-listed_species[ ! listed_species$Common_Name %in% c(other_species_list,cetacean_list), ]
```

# **Search Results:**
## **EMPHASIS ON SPECIES LISTED BY THE SPECIES AT RISK ACT, ASSESSED BY COSEWIC AND/OR WILD SPECIES  (Table x)**  
## **Information from National Aquatic Species at Risk Program**  

This section...

### **Species At Risk Distribution and Critical Habitat data**  

```{r Set up paths for National Aquatic Species at Risk Section, include=FALSE, cache=FALSE}
fl <- list.files(dataPath,".csv")
ClippedCritHab <- st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/ClipCritHab.shp", quiet=TRUE)
#SAR distribution shapefile was clipped from National shapefile as follows:
#sardist<-st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/Distribution_FGP_fixed_clipped.shp", quiet=TRUE)
#sardist_4326 <- st_transform(sardist, crs = 4326)
#st_write(sardist_4326, "../../../Data/NaturalResources/Species/SpeciesAtRisk/sardist_4326.shp")
sardist<-st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/sardist_4326.shp", quiet=TRUE)
leatherback_shp<-st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/LeatherBackTurtleCriticalHabitat/LBT_CH_2013.shp", quiet=TRUE)
```

#### **DFO Species At Risk distribution (range)**  
Contact: <info@dfo-mpo.gc.ca>  
Link: <https://open.canada.ca/data/en/dataset/e0fabad5-9379-4077-87b9-5705f28c490b> Last retrieved on: October 1 2020 from Open Data  
Quality Tier: **High**  
Security level: none  

#### **Critical Habitat of Species At Risk**  
Contact: <info@dfo-mpo.gc.ca>  
Link: <https://open.canada.ca/data/en/dataset/db177a8c-5d7d-49eb-8290-31e6a45d786c>  
Last retrieved on: October 1 2020 from Open Data  
Quality Tier: **High**  
Security level: none  

#### **Area-specific SAR distribution and critical habitat search results**

```{r echo=FALSE, results='asis'}
intersect_dist <- st_intersection(sardist,PEZ_poly_st)
intersect_dist$Common_Nam[intersect_dist$Common_Nam == "Sowerby`s Beaked Whale"] <- "Sowerby's Beaked Whale"
Common_Name<-intersect_dist$Common_Nam
Scientific_Name<-intersect_dist$Scientific
Population<-intersect_dist$Population
Area<-intersect_dist$Waterbody
intersect_dist_df<-as.data.frame(cbind(Common_Name, Scientific_Name, Population, Area))

#append columns from listed species 
dist_table<-merge(intersect_dist_df, listed_species, by='Scientific_Name')
x<-as.numeric(nrow(dist_table))
dist_table2<-dist_table %>% 
  transmute(Common_Name, Scientific_Name, Population, Area, Schedule.status, COSEWIC.status, Wild_Species)
dist_table3<- dist_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                     "Common Name"=Common_Name,
                                     "Scientific Name"=Scientific_Name)
Query_output_dist<-if(x < 1){
  "The provided polygon does not overlap with species at risk distribution range."
} else {
  "The provided polygon overlaps with species at risk distribution range."
}
Query_output_dist2<-noquote(Query_output_dist)

writeLines(c(Query_output_dist2), sep = "\n")
```

```{r echo=FALSE, results='asis'}
Query_output_table<-if(x < 1){
  ""
} else {
  kable(dist_table3[!duplicated(dist_table3),], caption= "Quality Tier: High. Security level: none. Species At Risk listed as Endangered, Threatened or Special Concern under the Species At Risk Act for which the search polygon overlaps with their distribution (range). This is not the authoritative source or advice for Species At Risk data. Please access the Species At Risk GIS tool to create the authoritative SARA report.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}

if(x > 1){Query_output_table}

```

#### **Species at Risk Critical Habitat Search Results**

```{r echo=FALSE, results='asis'}
intersect <- st_intersection(ClippedCritHab,PEZ_poly_st)
x<-as.numeric(nrow(intersect))
CommonName<-intersect$Common_Nam
Population<-intersect$Population
Area<-intersect$Waterbody
SARA_status<-intersect$SARA_Statu
intersect_df<-data.table(expand.grid(CommonName = CommonName, Population = Population, Area=Area, SARA_status=SARA_status))
Query_output_crit<-if(x < 1){
  "The provided polygon does not overlap with defined critical habitat."
} else {
  "The provided polygon overlaps with Critical Habitat."
}

Query_output_crit2<-noquote(Query_output_crit)

writeLines(c(Query_output_crit2), sep = "\n")
```
```{r echo=FALSE, results='asis'}
Query_output_table<-if(x < 1){
  ""
} else {
  kable(intersect_df[!duplicated(intersect_df),], caption="Quality Tier: High. Security level: none. Species At Risk listed as Endangered or Threatened under the Species At Risk Act (SARA) for which the search polygon overlaps with their critical habitat. Critical habitat is defined under section 2 of SARA as: “the habitat that is necessary for the survival or recovery of a listed wildlife species and that is identified as the species’ critical habitat in the recovery strategy or in an action plan for the species”. Critical Habitat is identified in a species’ recovery strategy or action plan, posted on the SAR Public Registry (www.sararegistry.gc.ca). This is not the authoritative source or advice for Species At Risk data. Please access the Species At Risk GIS tool to create the authoritative SARA report.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}
Query_output_table2<-noquote(Query_output_table)

if(x > 1){print(Query_output_table2)}
```

```{r Fig X PEZ polygon with all maritime Critical Habitat polygons, fig.height=8, fig.width=11, fig.cap="Quality Tier: High. Security level: none. This map summarizes areas where the search polygon overlaps with critical habitat of Species At Risk listed as Endangered or Threatened under the Species At Risk Act (SARA). Critical habitat is defined under section 2 of SARA as: “the habitat that is necessary for the survival or recovery of a listed wildlife species and that is identified as the species’ critical habitat in the recovery strategy or in an action plan for the species”. Critical Habitat is identified in a species’ recovery strategy or action plan, posted on the SAR Public Registry (www.sararegistry.gc.ca). This is not the authoritative source or advice for Species At Risk data. Please access the Species At Risk GIS tool to create the authoritative report."}
plot_crithab(ClippedCritHab, PEZ_poly_st, land_sf)

```

```{r Fig X close up of PEZ polygon, fig.height=8, fig.width=11, fig.cap="Zoomed view of figure above."}
plot_crithab_zoom(ClippedCritHab, PEZ_poly_st, land_sf)
```

#### **Draft: Leatherback Search Results**  

```{r echo=FALSE, results='asis'}
#function for overlap
leatherback_overlap(leatherback_shp=leatherback_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for sector
leatherback_area(leatherback_shp=leatherback_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r Fig X PEZ polygon with all maritime leatherback polygons, fig.height=8, fig.width=11, fig.cap="Map showing Leatherback Sea Turtle Important Habitat (green) relative to the defined Potential Exposure Zone (PEZ; blue) and proposed project polygon (yellow)."}
plot_leatherback(leatherback_shp, PEZ_poly_st, land_sf)
```