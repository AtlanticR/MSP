```{r load packages, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
library(easypackages)
libraries("Mar.datawrangling","knitr","kableExtra","rgdal","maps","lubridate","raster","RCurl","sf","stringr","ggplot2","data.table","gridExtra","dplyr",
          "stars","ggspatial","tidyverse","standardPrintOutput")
```
```{r load source functions, include=FALSE, cache=FALSE}
source("site_map.r")
source("site_map_new.r")
source("filter_wsdb.r")
source("filter_narwc_new.r")
source("EBSA.R")
source("leatherback.R")
source("cetacean_priority_areas.R")
source("Blue_Whale_habitat.R")
source("fn_SearchRVData.r")
source("fn_Search_ISDB_Data.r")
source("fn_maps.r")
source("fn_Search_MARFIS_Data.r")
```
```{r Define Site, include=FALSE, cache=FALSE}
AquaSiteName <- "FarmersLedge"
PEZversion <- "4748m"
minYear <- 2002
```
```{r set up paths, include=FALSE, cache=FALSE}
mspPath <- "../"
data.dir = "../../../Data/mar.wrangling"
dataPath <- file.path("../../../Data/outputs",paste0(AquaSiteName,PEZversion))
polyPath <- "../../../Data/Zones/SearchPEZpolygons"
site <- readOGR(polyPath,layer=paste0("Site_",AquaSiteName))
site_sf <- st_as_sf(site)
land_sf<-st_read("../../../Data/Boundaries/Coast50K/Coastline50k_SHP/Land_AtlCanada_ESeaboardUS.shp", quiet=TRUE)
pl <- list.files(polyPath,"*.shp")
pl <- pl[-grep("xml",pl)]
PEZ_poly <- readOGR(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]))
PEZ_poly_st<-st_as_sf(PEZ_poly)
```
```{r load SAR species lists, include=FALSE, cache=FALSE}
listed_species<-read.csv("../../../Data/NaturalResources/Species/MAR_listed_species.csv")
cetacean_list<-c("Beluga Whale", "Humpback Whale" , "North Atlantic Right Whale", "Fin Whale", "Northern Bottlenose Whale", "Harbour Porpoise", "Killer Whale", "Blue Whale", "Sei Whale", "Sowerby's Beaked Whale")
other_species_list<-c("Loggerhead Sea Turtle", "Atlantic Walrus", "Harbour Seal Lacs des Loups Marins subspecies", "Leatherback Sea Turtle")
listed_cetacean_species<-subset(listed_species, Common_Name %in% cetacean_list)
listed_other_species<-subset(listed_species, Common_Name %in% other_species_list)
listed_fish_invert_species<-listed_species[ ! listed_species$Common_Name %in% c(other_species_list,cetacean_list), ]
```
```{r load data sets used by multiple sections, include=FALSE, cache=FALSE}
obis<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/OBIS_MAR_priority_records.csv")
obis<-subset(obis,year>minYear)
```

## **Fish and Invertebrates**

This section...

```{r read fish and invertebrate files, include=FALSE, cache=FALSE}
fl <- list.files(dataPath,".csv")
cws<-read.csv("../../../Data/NaturalResources/Species/CWS_ECCC/CWS_ECCC_OBIS_records.csv")
cws<-subset(cws,year>minYear)
inat<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/iNaturalist_MAR_priority_records.csv")
inat<-subset(inat,datetime>minYear)
gbif<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/GBIF_MAR_priority_records.csv")
gbif<-subset(gbif,year>minYear)
```

### **Maritimes Research Vessel (RV) Survey**   

Contact: <DFO.MAR-PED-Data-Request-Demande-de-donnes-DEP-MAR.MPO@dfo-mpo.gc.ca>  
Last retrieved on: January 21, 2021 from Open Data <https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b>  
Quality Tier: **High**  
Search year: 1970-2020  
Security level: none  

### **Industry Survey Database (ISDB)**  
Contact: <Claire.Mussells@dfo-mpo.gc.ca>  
Last retrieved on: 2019  
Quality Tier: **Medium**  
Search year: 2002-2019  
Security level: Protected B  

### **The Maritime Fishery Information System (MARFIS)**  
Contact: <XMARComData@dfo-mpo.gc.ca>  
```{r echo=FALSE, results='asis'}
info<-file.info("../../../Data/mar.wrangling/MARFIS.PRO_SPC_INFO.RData")
LatestUpdate<-format(info[,"mtime"], format = "%B %d %Y")
last_retrieved<-c("Last retrieved on: ",LatestUpdate)
writeLines(c("Last retrieved on:",LatestUpdate), sep = " ")
```
Quality Tier: **Medium**  
Search year: 2002-2019  
Security level: Protected B  

### **Ocean Biodiversity Information System (OBIS)**  
Contact: <helpdesk@obis.org>  
URL: <https://obis.org/>  
Last retrieved on: January 27 2021 from OBIS  
Quality Tier: **Medium**  
Search year: xxxx  
Security level: none  

#### **Area-specific Maritimes Research Vessel (RV) Survey search results**
```{r, include=FALSE, cache=FALSE}
SurveyPrefix <- c("4VSW", "FALL", "SPRING", "SUMMER")
File <- c("_2020_GSCAT.csv", "_2020_GSINF.csv", "_2020_GSSPECIES.csv")
RVCatch <-  SelectRV_fn(SurveyPrefix, File, AquaSiteName, PEZversion, minYear)
RVCatch$database<-"rv"
rv_freq <- aggregate(
        x = list(Records = RVCatch$COMM),
      by = list(Scientific_Name = RVCatch$SPEC, Common_Name=RVCatch$COMM, Individuals=RVCatch$TOTNO, Set_No=RVCatch$SETNO
      ),
      length
      )
rv_freq_SAR<-rv_freq %>% select(Scientific_Name, Common_Name, Individuals, Records, Set_No) %>% filter (Scientific_Name %in% listed_fish_invert_species$Scientific_Name_upper)

rv_freq2<-aggregate(x=rv_freq[,sapply(rv_freq,is.numeric)],
                   by=c(rv_freq["Scientific_Name"], rv_freq["Common_Name"]),
                    sum)
rv_freq_table<-select(rv_freq2, Scientific_Name, Common_Name, Individuals, Records)
rv_freq_table<-arrange(rv_freq_table, Scientific_Name)
rv_freq_SAR2<-aggregate(x=rv_freq_SAR[,sapply(rv_freq_SAR,is.numeric)],
                   by=c(rv_freq_SAR["Scientific_Name"], rv_freq_SAR["Common_Name"]),
                    sum)

rv_freq_SAR2<-arrange(rv_freq_SAR2, Scientific_Name)

#Table with scientific name, common name, individual counts and number of records
Total_number_records_RV <- sum(rv_freq[[4]])
Total_number_individuals_RV <- sum(rv_freq[[3]])
Total_number_sets_RV<-length(unique(rv_freq$Set_No))
Total_number_SAR_records_RV <- sum(rv_freq_SAR2[[4]])
Total_number_SAR_individuals_RV <- sum(rv_freq_SAR2[[3]])
Total_number_SAR_sets_RV<-length(unique(rv_freq_SAR$Set_No))

RV_summarytable<-data.frame(matrix(ncol = 3, nrow = 2)) 
colnames(RV_summarytable)<-c("Total Individuals", "Total Records", "Total Sets")
rownames(RV_summarytable)<-c("Species at Risk", "All Species")

RV_summarytable[2,2]<-Total_number_records_RV
RV_summarytable[2,1]<-Total_number_individuals_RV
RV_summarytable[2,3]<-Total_number_sets_RV
RV_summarytable[1,2]<-Total_number_SAR_records_RV
RV_summarytable[1,1]<-Total_number_SAR_individuals_RV
RV_summarytable[1,3]<-Total_number_SAR_sets_RV
```

```{r}
Report_RV<-if(x < 1){
    "There are no relevant records in the Maritimes Research Vessel (RV) Survey for this search area."
  } else {
    "There are relevant records in the Maritimes Research Vessel (RV) Survey for this search area."
}
```

```{r}
kable(as.data.frame(RV_summarytable, position = "left"))  %>%
kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
#Develop final RV SAR table
rv_SAR_table<-as.data.frame(rv_freq_SAR2)
rv_SAR_table<-rv_SAR_table %>% rename(Scientific_Name_upper=Scientific_Name)
rv_SAR_table<-mutate(rv_SAR_table, Catch_Frequency=format(round((Records/Total_number_SAR_sets_RV)*100,1), nsmall=1))
rv_SAR_table<-merge(rv_SAR_table, listed_fish_invert_species, by='Scientific_Name_upper')
rv_SAR_table<-select(rv_SAR_table, Scientific_Name, Common_Name.y, Individuals, Records, Catch_Frequency,
                             COSEWIC.status, Schedule.status,Wild_Species)
colnames(rv_SAR_table)<-c("Scientific Name", "Common Name", "No. of Individuals", "Catch Events", 
                          "Catch Frequency", "COSEWIC listing", "SARA status", "Wild Species")

```

```{r}
kable(rv_SAR_table, align="l", caption="Quality Tier: High. Security level: none. Maritimes Research Vessel (RV) Survey observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r}
#Convert geometry to latitude and longitude
RVCatch <- RVCatch %>% extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE)
rv_start_sites<-data.frame(unique(cbind(longitude=RVCatch$lon, latitude=RVCatch$lat)))
rv_end_sites<-data.frame(unique(cbind(longitude=RVCatch$ELONG, latitude=RVCatch$ELAT)))
startx <- rv_start_sites$longitude
starty <- rv_start_sites$latitude
endx <- rv_end_sites$longitude
endy <- rv_end_sites$latitude
```

```{r Fig 2 Ecosystem RV Survey records with polygon, fig.height=8, fig.width=11, fig.cap= "Quality Tier: High. Security level: none. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query information from the Maritimes Research Vessel (RV) Survey. Black lines and arrows indicate the location and direction of each bottom otter trawl sample."}
site_map_new(PEZ_poly,PEZ_poly_st,site_sf,land_sf,2)+
  geom_point(data = rv_start_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, colour = "darkgreen")+
  geom_point(data = rv_end_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, colour = "firebrick4")+
  geom_segment(aes(x = startx, y = starty, xend = endx, yend = endy),arrow=arrow(), size = 1.25)
```

#### **Area-specific MARFIS & ISDB search results**
```{r, include=FALSE, cache=FALSE}
##skip all of these steps and create an isdb file for all of the MAR region.
#df_to_shp(df= isdb, file = "isdb_shp", lat.field = "LATITUDE",lon.field = "LONGITUDE")
#isdb_shp <- st_read("../../../Data/outputs/FarmersLedge4748m/isdb_20190927_1201.shp", quiet=TRUE)
#ISDBCatch <-  SelectISDB_fn(AquaSiteName, PEZversion, minYear)
wd <- getwd() # store main project directory
  data.dir = "../../../Data/mar.wrangling"  # location of ISDB datafiles
  dsn <- "../../../Data/Zones/SearchPEZpolygons"

  # Import the ISDB tables
  get_data('isdb', data.dir=data.dir)
  
  #ISSETPROFILE_WIDE corrections 
  set2<-ISSETPROFILE_WIDE %>%
    mutate(DATE_TIME1 = na_if(DATE_TIME1, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME2 = na_if(DATE_TIME2, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME3 = na_if(DATE_TIME3, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME4 = na_if(DATE_TIME4, "9999-01-01 AST"))
  set2$DATE_TIME1[is.na(set2$DATE_TIME1)] <- set2$DATE_TIME2[is.na(set2$DATE_TIME1)]         
  set2$DATE_TIME4[is.na(set2$DATE_TIME4)] <- set2$DATE_TIME3[is.na(set2$DATE_TIME4)]         
  
  set2$LAT1[is.na(set2$LAT1)] <- set2$LAT2[is.na(set2$LAT1)]  
  set2$LONG1[is.na(set2$LONG1)] <- set2$LONG2[is.na(set2$LONG1)]
  
  set2$LAT4[is.na(set2$LAT4)] <- set2$LAT3[is.na(set2$LAT4)]  
  set2$LONG4[is.na(set2$LONG4)] <- set2$LONG3[is.na(set2$LONG4)]
  
  set2$YEAR<-str_sub(set2$DATE_TIME1, start=1, end=4)
  set2<- set2 %>% rename(LATITUDE=LAT1)
  set2<- set2 %>% rename(LONGITUDE=LONG1)
  set3 <-  clip_by_poly(df = set2,
                        lat.field = "LATITUDE",
                        lon.field = "LONGITUDE",
                        clip.poly = PEZ_poly)
  ISSETPROFILE_WIDE <- set3[set3$YEAR >= minYear,]
  
  # limit by year
  self_filter(keep_nullsets = FALSE,quiet = TRUE)
  dsn <- "C:/Temp"
  setwd(dsn)
  save_data(db='isdb')  # this creates both a csv and a shp
  # of the clipped data.  Import the shp as an sf object and 
  # pass back to main script as ISDB_INTERSECT

    # read in the newly created ISDB shapefile
  # as an sf object.

  files <- list.files(dsn,".shp")
  isdb_shp <- files[grep("isdb_",files)] # get shapefile name
  isdb_shp <- substr(isdb_shp,1,nchar(isdb_shp)-4) # remove '.shp' extension

  isdb_sf <- st_read(dsn, layer = isdb_shp, quiet=TRUE)
  # remove all files created by save_data() (shapefile and CSV)
  fl <- list.files(dsn,isdb_shp)
  for(i in 1:length(fl)) {
    file.remove(fl[i])
  }  
  setwd(wd) #revert to original working directory

isdb_intersect <- st_intersection(isdb_sf,PEZ_poly_st)
isdb_sites<-data.frame(longitude=isdb_intersect$LONGI, latitude=isdb_intersect$LATIT)
```

```{r, include=FALSE, cache=FALSE}
isdb_freq <- aggregate(
      x = list(Records = isdb_intersect$SCIENTIFIC),
      by = list(Species = isdb_intersect$SCIENTIFIC),
      length)
isdb_freq <- isdb_freq[order(-isdb_freq$Records),]
rownames(isdb_freq) <- c()
isdb_freq_table<- isdb_freq %>% rename(Scientific_Name_upper=Species)
isdb_freq_table<-merge(isdb_freq_table, listed_fish_invert_species, by='Scientific_Name_upper')
isdb_freq_table2<-isdb_freq_table %>% 
  transmute(Scientific_Name, Common_Name, Schedule.status, COSEWIC.status, Wild_Species, Records)
isdb_record_table<- isdb_freq_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                     "Scientific Name"=Scientific_Name,
                                     "Common Name"=Common_Name)
Total_number_records_isdb <- sum(isdb_freq$Records)
isdb_poly_SAR_total<-isdb_freq %>% select(Species, Records) %>% filter (Species %in% listed_fish_invert_species$Scientific_Name_upper)
Total_number_SAR_records_isdb<-sum(isdb_poly_SAR_total$Records)
```

```{r}
isdb_set_summary_table<-data.frame(Total_organisms_recorded_in_polygon="", LISTED_organisms_recorded_in_polygon="")
isdb_set_summary_table[1,1]<-Total_number_records_isdb
isdb_set_summary_table[1,2]<-Total_number_SAR_records_isdb
isdb_set_summary_table<- isdb_set_summary_table %>% rename("Total organisms recorded in polygon"=Total_organisms_recorded_in_polygon,
                                                           "Listed organisms recorded in polygon"=LISTED_organisms_recorded_in_polygon)

```

```{r}
#table with scientific names of species and number of records
isdb_poly_SAR_records<-isdb_intersect %>% select(SCIENTIFIC, COMMON) %>% filter (SCIENTIFIC %in% listed_fish_invert_species$Scientific_Name_upper)
x<-as.numeric(nrow(isdb_poly_SAR_records))
Report_isdb<-if(x < 1){
    "There are no relevant records in the Industry Survey Database (ISDB) for this search area."
  } else {
    "There are relevant records in the Industry Survey Database (ISDB) for this search area."
}
```

```{r}
(kable(isdb_set_summary_table, align="c", caption="Summary of area-specific ISDB search results.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left"))
```

```{r}
kable(isdb_record_table, align="l", caption="Quality Tier: Medium. Security level: Protected B. Industry Survey Database (ISDB) observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
**Note:** A complete list of ISDB observation records of all species within the provided polygon can be found in the Appendix.

```{r, include=FALSE, cache=FALSE}
#source("fn_Search_MARFIS_Data.r")
#marfis_shp <- st_read("../../../Data/outputs/FarmersLedge4748m/marfis_20190927_1202.shp", quiet=TRUE)

#MARFISCatch <-SelectMARFIS_fn(AquaSiteName, PEZversion, minYear)
wd <- getwd() # store main project directory
  data.dir = "../../../Data/mar.wrangling"  # location of MARFIS datafiles
  dsn <- "../../../Data/Zones/SearchPEZpolygons"

  #Import the MARFIS tables
  #This command did not work for me
  #get_data('marfis', data.dir=data.dir)
  #I developed these instead
  filenames <- list.files(data.dir, pattern="MARFIS*", full.names=TRUE)
  lapply(filenames,load,.GlobalEnv)
    # limit data by MinYear and clip to PEZPoly
  db='marfis'
  PRO_SPC_INFO <-  clip_by_poly(df = PRO_SPC_INFO,
                                lat.field = "LATITUDE",
                                lon.field = "LONGITUDE",
                                clip.poly = PEZ_poly)
  # limit by year
  PRO_SPC_INFO <- PRO_SPC_INFO[PRO_SPC_INFO$YEAR >= minYear,]
  self_filter(keep_nullsets = FALSE,quiet = TRUE)
  dsn <- "C:/Temp"
  setwd(dsn)
  save_data(db='marfis')  # this creates both a csv and a shp
  # of the clipped data.  Import the shp as an sf object and 
  # pass back to main script as MARFIS_INTERSECT
    # read in the newly created MARFIS shapefile
  # as an sf object.
  files <- list.files(dsn,".shp")
  marfis_shp <- files[grep("marfis_",files)] # get shapefile name
  marfis_shp <- substr(marfis_shp,1,nchar(marfis_shp)-4) # remove '.shp' extension
  marfis_sf <- st_read(dsn, layer = marfis_shp, quiet=TRUE)
  # remove all files created by save_data() (shapefile and CSV)
  fl <- list.files(dsn,marfis_shp)
  for(i in 1:length(fl)) {
    file.remove(fl[i])
  }  
  setwd(wd)
marfis_intersect <- st_intersection(marfis_sf,PEZ_poly_st)
marfis_sites<-data.frame(longitude=marfis_intersect$LONGITUDE, latitude=marfis_intersect$LATITUDE)
```

```{r, include=FALSE, cache=FALSE}
marfis_freq <- aggregate(
      x = list(Records = marfis_intersect$SPIES_N),
      by = list(Species = marfis_intersect$SPIES_N),
      length)
marfis_freq <- marfis_freq[order(-marfis_freq$Records),]
rownames(marfis_freq) <- c()
marfis_freq_table<- marfis_freq %>% rename(Common_Name_upper=Species)
marfis_freq_table<-merge(marfis_freq_table, listed_fish_invert_species, by='Common_Name_upper')
marfis_freq_table2<-marfis_freq_table %>% 
  transmute(Scientific_Name, Common_Name, Schedule.status, COSEWIC.status, Wild_Species, Records)
marfis_record_table<- marfis_freq_table2 %>% rename("SARA status"=Schedule.status,
                                                    "COSEWIC listing"=COSEWIC.status,
                                                    "Wild Species listing"=Wild_Species,
                                                    "Scientific Name"=Scientific_Name,
                                                    "Common Name"=Common_Name)
Total_number_records_marfis <- sum(marfis_freq$Records)
marfis_poly_SAR_total<-marfis_freq %>% select(Species, Records) %>% filter (Species %in% listed_fish_invert_species$Common_Name_upper)
Total_number_SAR_records_marfis<-sum(marfis_poly_SAR_total$Records)
```

```{r}
marfis_record_summary_table<-data.frame(Total_organisms_recorded_in_polygon="", LISTED_organisms_recorded_in_polygon="")
marfis_record_summary_table[1,1]<-Total_number_records_marfis
marfis_record_summary_table[1,2]<-Total_number_SAR_records_marfis

```

```{r}
#table with scientific names of species and number of records
marfis_poly_SAR_records<-marfis_intersect %>% select(SPIES_N) %>% filter (SPIES_N %in% listed_fish_invert_species$Common_Name_upper)
x<-as.numeric(nrow(marfis_poly_SAR_records))
Report_isdb<-if(x < 1){
    "There are no relevant records in the Maritimes Fishery Information System (MARFIS) for this search area."
  } else {
    "There are relevant records in the Maritimes Fishery Information System (MARFIS) for this search area."
}
```

```{r}
(kable(marfis_record_summary_table, align="c", caption="Summary of area-specific MARFIS search results.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left"))
```

```{r}
kable(marfis_record_table, align="l", caption="Quality Tier: Medium. Security level: Protected B. Maritimes Fishery Information System (MARFIS) observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

**Note:** A complete list of MARFIS observation records of all species within the provided polygon can be found in the Appendix.

```{r Fig MARFIS and ISDB records, fig.height=8, fig.width=11, fig.cap="Quality Tier: Medium. Security level: Protected B. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query aggregated information from Maritimes Fishery Information System (MARFIS) and/or Industry Survey Database (ISDB) observation records shown as black points, for all species. Rule of five was not applied."}
site_map_new(PEZ_poly,PEZ_poly_st,site_sf,land_sf,2)+
  geom_point(data = isdb_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")+
  geom_point(data = marfis_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")
```

#### **OBIS Search Results**
```{r, include=FALSE, cache=FALSE}
#Select columns of interest from OBIS file
obis_edit<-obis %>% 
  transmute(scientificName, decimalLatitude, decimalLongitude, year,individualCount, rightsHolder, institutionID, institutionCode, collectionCode, datasetID)
 
#Separate CWS/ECCC records
#CWS.ECCC.OBIS_records<-filter(obis_edit, institutionCode=="Canadian Wildlife Service-Atlantic, Environment and Climate Change Canada")
#write.csv(CWS.ECCC.OBIS_records, "CWS_ECCC_OBIS_records.csv")

#Delete WSDB and CWS/ECCC records
obis_edit2<-obis_edit %>%
  filter(! institutionCode =="Canadian Wildlife Service-Atlantic, Environment and Climate Change Canada")
obis_edit3<-obis_edit2 %>%
  filter(! collectionCode =="WHALESITINGS")

obis_plot_locations<-st_as_sf(obis_edit3, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)
intersect_obis <- st_intersection(obis_plot_locations,PEZ_poly_st)
x<-as.numeric(nrow(intersect_obis))

#summarize individual counts
#species_sum<-aggregate(intersect_obis$individualCount, by=list(Species=intersect_obis$scientificName), FUN=sum)

#append columns from listed species
intersect_obis<- intersect_obis %>% rename(Scientific_Name=scientificName)

obis_fish_table<-merge(intersect_obis, listed_fish_invert_species, by='Scientific_Name')
x<-as.numeric(nrow(obis_fish_table))
obis_fish_table2<-obis_fish_table %>% 
  select(Common_Name, Scientific_Name, Schedule.status, COSEWIC.status, Wild_Species)
obis_fish_table3<- obis_fish_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                                    "Scientific Name"=Scientific_Name,
                                                    "Common Name"=Common_Name 
                                     )
obis_fish_table3$geometry<-NULL
obis_fish_table4<-unique(obis_fish_table3)
```

```{r, echo=FALSE, results='asis',}
Query_output_obis<-if(x < 1){
  "There are no relevant records in the Ocean Biodiversity Information System (OBIS) for this search area."
} else {
  "There are relevant records in the Ocean Biodiversity Information System (OBIS) for this search area."
}
writeLines(c(Query_output_obis), sep = "\n")
```

```{r echo=FALSE, results='asis', caption="Priority species with observations contained in the OBIS database within the search polygon area."}
OBIS_query_output_table<-if(x < 1){
  ""
} else {
  kable(obis_fish_table4, row.names = F, caption="Quality Tier: Medium. Security level: none. Ocean Biodiversity Information System (OBIS)
observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild Species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}

if(x > 1){OBIS_query_output_table}
```
```{r Fig OBIS records for fish and invertebrates in PEZ polygon, fig.height=8, fig.width=11, fig.cap="Quality Tier: Medium. Security level: none. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query information from Ocean Biodiversity Information System (OBIS) observation records, for species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. Sightings on land are an indicator that the sighting data have not yet been completely error-checked or that animals were sighted from shore. The absence of a species in this figure should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area."}
if(x > 1){plot_obis(PEZ_poly,PEZ_poly_st,site_sf,land_sf,intersect_obis,2)}
```
