## **FISH AND INVERTEBRATES**    

This section...

```{r read fish and invertebrate files, include=FALSE, cache=FALSE}
fl <- list.files(dataPath,".csv")
cws<-read.csv("../../../Data/NaturalResources/Species/CWS_ECCC/CWS_ECCC_OBIS_records.csv")
cws<-subset(cws,year>minYear)
inat<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/iNaturalist_MAR_priority_records.csv")
inat<-subset(inat,datetime>minYear)
gbif<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/GBIF_MAR_priority_records.csv")
gbif<-subset(gbif,year>minYear)
```

### **Maritimes Research Vessel (RV) Survey**    

Contact: <DFO.MAR-PED-Data-Request-Demande-de-donnes-DEP-MAR.MPO@dfo-mpo.gc.ca>  
Last retrieved on: January 21, 2021 from [Open Data](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b)  
Quality Tier: High  
Search year: 1970-2020  
Security level: none  

#### ***Area-specific Maritimes Research Vessel (RV) Survey search results***    

```{r, include=FALSE, cache=FALSE}
SurveyPrefix <- c("4VSW", "FALL", "SPRING", "SUMMER")
File <- c("_2020_GSCAT.csv", "_2020_GSINF.csv", "_2020_GSSPECIES.csv")
RVCatch <-  SelectRV_fn(SurveyPrefix, File, AquaSiteName, PEZversion, minYear)
RVCatch$database<-"rv"
rv_freq <- aggregate(
      x = list(Records = RVCatch$COMM),
      by = list(Scientific_Name = RVCatch$SPEC, Common_Name=RVCatch$COMM, Individuals=RVCatch$TOTNO, Set_No=RVCatch$SETNO),
      length)
rv_freq_SAR<-rv_freq %>% select(Scientific_Name, Common_Name, Individuals, Records, Set_No) %>% filter (Scientific_Name %in% listed_fish_invert_species$Scientific_Name_upper)

rv_freq2<-aggregate(x=rv_freq[,sapply(rv_freq,is.numeric)],
                   by=c(rv_freq["Scientific_Name"], rv_freq["Common_Name"]),
                    sum)
rv_freq_table<-select(rv_freq2, Scientific_Name, Common_Name, Individuals, Records)
rv_freq_table<-arrange(rv_freq_table, Scientific_Name)
rv_freq_table<-rv_freq_table %>% rename("Scientific Name"=Scientific_Name,
                                        "Common Name"=Common_Name)
rv_freq_SAR2<-aggregate(x=rv_freq_SAR[,sapply(rv_freq_SAR,is.numeric)],
                   by=c(rv_freq_SAR["Scientific_Name"], rv_freq_SAR["Common_Name"]),
                    sum)
rv_freq_SAR2<-arrange(rv_freq_SAR2, Scientific_Name)

#Table with scientific name, common name, individual counts and number of records
Total_number_records_RV <- sum(rv_freq[[4]])
Total_number_individuals_RV <- sum(rv_freq[[3]])
Total_number_sets_RV<-length(unique(rv_freq$Set_No))
Total_number_SAR_records_RV <- sum(rv_freq_SAR2[[4]])
Total_number_SAR_individuals_RV <- sum(rv_freq_SAR2[[3]])
Total_number_SAR_sets_RV<-length(unique(rv_freq_SAR$Set_No))

RV_summarytable<-data.frame(matrix(ncol = 3, nrow = 2)) 
colnames(RV_summarytable)<-c("Total Individuals", "Total Records", "Total Sets")
rownames(RV_summarytable)<-c("Species at Risk", "All Species")

RV_summarytable[2,2]<-Total_number_records_RV
RV_summarytable[2,1]<-Total_number_individuals_RV
RV_summarytable[2,3]<-Total_number_sets_RV
RV_summarytable[1,2]<-Total_number_SAR_records_RV
RV_summarytable[1,1]<-Total_number_SAR_individuals_RV
RV_summarytable[1,3]<-Total_number_SAR_sets_RV
RV_summarytable<-as.data.frame(RV_summarytable, position = "left")
```

*
```{r, comment="", prompt=TRUE, echo=FALSE, results='asis'}
Report_RV<-if(Total_number_SAR_records_RV < 1){
    "There are no relevant records in the Maritimes Research Vessel (RV) Survey for this search area."
  } else {
    "There are relevant records in the Maritimes Research Vessel (RV) Survey for this search area."
  }
Report_RV<-noquote(Report_RV)
writeLines(Report_RV)
```

```{r}
kable(RV_summarytable, align="l", caption='Quality Tier: High. Security level: none. Summary of Maritimes Research Vessel (RV) Survey observation records of species contained within the search area and listed by the Species At Risk Act (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild Species listings, assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listing. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.') %>%
kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r}
#Develop final RV SAR table
rv_SAR_table<-as.data.frame(rv_freq_SAR2)
rv_SAR_table<-rv_SAR_table %>% rename(Scientific_Name_upper=Scientific_Name)
rv_SAR_table<-mutate(rv_SAR_table, Catch_Frequency=format(round((Records/Total_number_SAR_sets_RV)*100,1), nsmall=1))
rv_SAR_table<-merge(rv_SAR_table, listed_fish_invert_species, by='Scientific_Name_upper')
rv_SAR_table<-select(rv_SAR_table, Scientific_Name, Common_Name.y, Individuals, Records, Catch_Frequency,
                             COSEWIC.status, Schedule.status,Wild_Species)
colnames(rv_SAR_table)<-c("Scientific Name", "Common Name", "No. of Individuals", "Catch Events", 
                          "Catch Frequency", "COSEWIC listing", "SARA status", "Wild Species")

```

```{r}
#Convert geometry to latitude and longitude
RVCatch <- RVCatch %>% extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE)
rv_start_sites<-data.frame(unique(cbind(longitude=RVCatch$lon, latitude=RVCatch$lat)))
rv_end_sites<-data.frame(unique(cbind(longitude=RVCatch$ELONG, latitude=RVCatch$ELAT)))
startx <- rv_start_sites$longitude
starty <- rv_start_sites$latitude
endx <- rv_end_sites$longitude
endy <- rv_end_sites$latitude
```

```{r, fig.height=8, fig.width=11, fig.cap= 'Quality Tier: High. Security level: none. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query information from the Maritimes Research Vessel (RV) Survey. Black lines and arrows indicate the location and direction of each bottom otter trawl sample.'}
site_map(PEZ_poly,PEZ_poly_st,site_sf,land_sf,2)+
  geom_point(data = rv_start_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, colour = "darkgreen")+
  geom_point(data = rv_end_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, colour = "firebrick4")+
  geom_segment(aes(x = startx, y = starty, xend = endx, yend = endy),arrow=arrow(), size = 1.25)
```

```{r}
kable(rv_SAR_table, align="l", caption="\\label{tab:rv_SAR_table}Quality Tier: High. Security level: none. Maritimes Research Vessel (RV) Survey observation records of species contained within the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listing. <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>", booktabs = T, escape = F, linesep="") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r}
kable(rv_freq_table, align="l", caption="\\label{tab:rv_freq_table}Quality Tier: High. Security level: none. Maritimes Research Vessel (RV) Survey observation records of <u>all species</u> contained within the search area, summarized by species or species group. <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>", booktabs = T, escape = F, linesep="") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

### **Industry Survey and Maritimes Fishery Databases**    

#### ***Industry Survey Database (ISDB)***    
Contact: <Claire.Mussells@dfo-mpo.gc.ca>  
```{r echo=FALSE, results='asis'}
info<-file.info("../../../Data/mar.wrangling/ISDB.ISSETTYPECODES.RData")
LatestUpdate<-format(info[,"mtime"], format = "%B %d %Y")
last_retrieved<-c("Last retrieved on: ",LatestUpdate)
writeLines(c("Last retrieved on:",LatestUpdate), sep = " ") 
```
Quality Tier: Medium  
Search year: 2002-2019  
Security level: Protected B  

#### ***The Maritime Fishery Information System (MARFIS)***    
Contact: <XMARComData@dfo-mpo.gc.ca>  
```{r echo=FALSE, results='asis'}
info<-file.info("../../../Data/mar.wrangling/MARFIS.PRO_SPC_INFO.RData")
LatestUpdate<-format(info[,"mtime"], format = "%B %d %Y")
last_retrieved<-c("Last retrieved on: ",LatestUpdate)
writeLines(c("Last retrieved on:",LatestUpdate), sep = " ")
```
Quality Tier: Medium  
Search year: 2002-2019  
Security level: Protected B  

#### ***Area-specific MARFIS & ISDB search results***    
```{r, include=FALSE, cache=FALSE}
##skip all of these steps and create an isdb file for all of the MAR region.
#df_to_shp(df= isdb, file = "isdb_shp", lat.field = "LATITUDE",lon.field = "LONGITUDE")
#isdb_shp <- st_read("../../../Data/outputs/FarmersLedge4748m/isdb_20190927_1201.shp", quiet=TRUE)
#ISDBCatch <-  SelectISDB_fn(AquaSiteName, PEZversion, minYear)
wd <- getwd() # store main project directory
  data.dir = "../../../Data/mar.wrangling"  # location of ISDB datafiles
  dsn <- "../../../Data/Zones/SearchPEZpolygons"

  # Import the ISDB tables
  get_data('isdb', data.dir=data.dir)
  
  #ISSETPROFILE_WIDE corrections 
  set2<-ISSETPROFILE_WIDE %>%
    mutate(DATE_TIME1 = na_if(DATE_TIME1, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME2 = na_if(DATE_TIME2, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME3 = na_if(DATE_TIME3, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME4 = na_if(DATE_TIME4, "9999-01-01 AST"))
  set2$DATE_TIME1[is.na(set2$DATE_TIME1)] <- set2$DATE_TIME2[is.na(set2$DATE_TIME1)]         
  set2$DATE_TIME4[is.na(set2$DATE_TIME4)] <- set2$DATE_TIME3[is.na(set2$DATE_TIME4)]         
  
  set2$LAT1[is.na(set2$LAT1)] <- set2$LAT2[is.na(set2$LAT1)]  
  set2$LONG1[is.na(set2$LONG1)] <- set2$LONG2[is.na(set2$LONG1)]
  
  set2$LAT4[is.na(set2$LAT4)] <- set2$LAT3[is.na(set2$LAT4)]  
  set2$LONG4[is.na(set2$LONG4)] <- set2$LONG3[is.na(set2$LONG4)]
  
  set2$YEAR<-lubridate::year(set2$DATE_TIME1)
  set2<- set2 %>% rename(LATITUDE=LAT1)
  set2<- set2 %>% rename(LONGITUDE=LONG1)
  set3 <-  clip_by_poly(df = set2,
                        lat.field = "LATITUDE",
                        lon.field = "LONGITUDE",
                        clip.poly = PEZ_poly)
  ISSETPROFILE_WIDE <- set3[set3$YEAR >= minYear,]
  
  # limit by year
  self_filter(keep_nullsets = FALSE,quiet = TRUE)
  dsn <- "C:/Temp"
  setwd(dsn)
  save_data(db='isdb')  # this creates both a csv and a shp
  # of the clipped data.  Import the shp as an sf object and 
  # pass back to main script as ISDB_INTERSECT

    # read in the newly created ISDB shapefile
  # as an sf object.

  files <- list.files(dsn,".shp")
  isdb_shp <- files[grep("isdb_",files)] # get shapefile name
  isdb_shp <- substr(isdb_shp,1,nchar(isdb_shp)-4) # remove '.shp' extension

  isdb_sf <- st_read(dsn, layer = isdb_shp, quiet=TRUE)
  # remove all files created by save_data() (shapefile and CSV)
  fl <- list.files(dsn,isdb_shp)
  for(i in 1:length(fl)) {
    file.remove(fl[i])
  }  
  setwd(wd) #revert to original working directory

isdb_intersect <- st_intersection(isdb_sf,PEZ_poly_st)
isdb_sites<-data.frame(longitude=isdb_intersect$LONGI, latitude=isdb_intersect$LATIT)
```

```{r, include=FALSE, cache=FALSE}
isdb_freq <- aggregate(
      x = list(Records = isdb_intersect$SCIENTIFIC),
      by = list(Scientific_Name = isdb_intersect$SCIENTIFIC, Common_Name = isdb_intersect$COMMON),
      length)
isdb_freq <- isdb_freq[order(-isdb_freq$Records),]
rownames(isdb_freq) <- c()
isdb_freq2<- isdb_freq %>% rename("Scientific_Name_upper"=Scientific_Name)
isdb_freq<- isdb_freq %>% rename("Scientific Name"=Scientific_Name,
                                 "Common Name"=Common_Name)
isdb_freq_SAR<-merge(isdb_freq2, listed_fish_invert_species, by='Scientific_Name_upper')
isdb_freq_SAR<-isdb_freq_SAR %>% 
  transmute(Scientific_Name, Common_Name.y, Schedule.status, COSEWIC.status, Wild_Species, Records)
isdb_SAR_record_table<- isdb_freq_SAR %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                     "Scientific Name"=Scientific_Name,
                                     "Common Name"=Common_Name.y)
Total_number_records_isdb <- sum(isdb_freq$Records)
Total_number_SAR_records_isdb<-sum(isdb_SAR_record_table$Records)
```

```{r}
isdb_set_summary_table<-data.frame(Total_organisms_recorded_in_polygon="", LISTED_organisms_recorded_in_polygon="")
isdb_set_summary_table[1,1]<-Total_number_records_isdb
isdb_set_summary_table[1,2]<-Total_number_SAR_records_isdb
isdb_set_summary_table<- isdb_set_summary_table %>% rename("Total organisms recorded in polygon"=Total_organisms_recorded_in_polygon,
                                                           "Listed organisms recorded in polygon"=LISTED_organisms_recorded_in_polygon)
```

```{r}
kable(isdb_set_summary_table, align="c", caption="\\label{tab:isdb_set_summary_table}Quality Tier: Medium. Security level: Protected B. Summary of Industry Survey Database (ISDB) observation records of species contained within the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listings. <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>", booktabs = T, escape = F, linesep="") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r, include=FALSE, cache=FALSE}
#source("fn_Search_MARFIS_Data.r")
#MARFISCatch <-SelectMARFIS_fn(AquaSiteName, PEZversion, minYear)
wd <- getwd() # store main project directory
  data.dir = "../../../Data/mar.wrangling"  # location of MARFIS datafiles
  dsn <- "../../../Data/Zones/SearchPEZpolygons"

  #Import the MARFIS tables
  #This command did not work for me
  #get_data('marfis', data.dir=data.dir)
  #I developed these instead
  filenames <- list.files(data.dir, pattern="MARFIS*", full.names=TRUE)
  lapply(filenames,load,.GlobalEnv)
    # limit data by MinYear and clip to PEZPoly
  db='marfis'
  PRO_SPC_INFO <-  clip_by_poly(df = PRO_SPC_INFO,
                                lat.field = "LATITUDE",
                                lon.field = "LONGITUDE",
                                clip.poly = PEZ_poly)
  # limit by year
  PRO_SPC_INFO <- PRO_SPC_INFO[PRO_SPC_INFO$YEAR >= minYear,]
  self_filter(keep_nullsets = FALSE,quiet = TRUE)
  dsn <- "C:/Temp"
  setwd(dsn)
  save_data(db='marfis')  # this creates both a csv and a shp
  # of the clipped data.  Import the shp as an sf object and 
  # pass back to main script as MARFIS_INTERSECT
    # read in the newly created MARFIS shapefile
  # as an sf object.
  files <- list.files(dsn,".shp")
  marfis_shp <- files[grep("marfis_",files)] # get shapefile name
  marfis_shp <- substr(marfis_shp,1,nchar(marfis_shp)-4) # remove '.shp' extension
  marfis_sf <- st_read(dsn, layer = marfis_shp, quiet=TRUE)
  # remove all files created by save_data() (shapefile and CSV)
  fl <- list.files(dsn,marfis_shp)
  for(i in 1:length(fl)) {
    file.remove(fl[i])
  }  
  setwd(wd)
marfis_intersect <- st_intersection(marfis_sf,PEZ_poly_st)
marfis_sites<-data.frame(longitude=marfis_intersect$LONGITUDE, latitude=marfis_intersect$LATITUDE)
```

```{r, include=FALSE, cache=FALSE}
marfis_freq <- aggregate(
      x = list(Records = marfis_intersect$SPIES_N),
      by = list(Species = marfis_intersect$SPIES_N),
      length)
marfis_freq <- marfis_freq[order(-marfis_freq$Records),]
rownames(marfis_freq) <- c()
marfis_freq_table<- marfis_freq %>% rename("Common Name"=Species)
marfis_freq_table2<- marfis_freq %>% rename(Common_Name_upper=Species)
marfis_freq_SAR<-merge(marfis_freq_table2, listed_fish_invert_species, by='Common_Name_upper')
marfis_freq_SAR<-marfis_freq_SAR %>% 
  transmute(Scientific_Name, Common_Name, Schedule.status, COSEWIC.status, Wild_Species, Records)
marfis_SAR_record_table<- marfis_freq_SAR %>% rename("SARA status"=Schedule.status,
                                                    "COSEWIC listing"=COSEWIC.status,
                                                    "Wild Species listing"=Wild_Species,
                                                    "Scientific Name"=Scientific_Name,
                                                    "Common Name"=Common_Name)
Total_number_records_marfis <- sum(marfis_freq_table$Records)
Total_number_SAR_records_marfis<-sum(marfis_SAR_record_table$Records)
```

```{r}
marfis_record_summary_table<-data.frame(Total_organisms_recorded_in_polygon="", LISTED_organisms_recorded_in_polygon="")
marfis_record_summary_table[1,1]<-Total_number_records_marfis
marfis_record_summary_table[1,2]<-Total_number_SAR_records_marfis
marfis_record_summary_table<- marfis_record_summary_table %>% rename("Total organisms recorded in polygon"=Total_organisms_recorded_in_polygon,
                                                           "Listed organisms recorded in polygon"=LISTED_organisms_recorded_in_polygon)
```

```{r}
(kable(marfis_record_summary_table, align="c", caption="\\label{tab:marfis_record_summary_table}Quality Tier: Medium. Security level: Protected B. Summary of Maritimes Fishery Information System (MARFIS) observation records of species contained within the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listings <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left"))
```

*
```{r, comment="", prompt=TRUE, echo=FALSE, results='asis'}
Report_isdb<-if(Total_number_SAR_records_isdb < 1){
    "There are no relevant records in the Industry Survey Database (ISDB) for this search area."
  } else {
    "There are relevant records in the Industry Survey Database (ISDB) for this search area."
  }
Report_isdb<-noquote(Report_isdb)
writeLines(Report_isdb)
```

*
```{r, comment="", prompt=TRUE, echo=FALSE, results='asis'}
Report_marfis<-if(Total_number_SAR_records_marfis < 1){
    "There are no relevant records in the Maritimes Fishery Information System (MARFIS) for this search area."
  } else {
    "There are relevant records in the Maritimes Fishery Information System (MARFIS) for this search area."
  }
Report_marfis<-noquote(Report_marfis)
writeLines(Report_marfis)
```

```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: Medium. Security level: Protected B. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query aggregated information from Maritimes Fishery Information System (MARFIS) and/or Industry Survey Database (ISDB) observation records shown as black points, for all species. Rule of five was not applied.'}
site_map(PEZ_poly,PEZ_poly_st,site_sf,land_sf,2)+
  geom_point(data = isdb_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")+
  geom_point(data = marfis_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")
```

```{r}
kable(isdb_SAR_record_table, align="l", caption="\\label{tab:isdb_SAR_record_table}Quality Tier: Medium. Security level: Protected B. Industry Survey Database (ISDB) observation records of species contained within the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listings. <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>", booktabs = T, escape = F, linesep="") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
kable(isdb_freq, align="l", caption="\\label{tab:isdb_freq}Quality Tier: Medium. Security level: Protected B. Industry Survey Database (ISDB) observation records of <u>all species</u> contained within the search area, summarized by species or species group. <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>", booktabs = T, escape = F, linesep="") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
kable(marfis_SAR_record_table, align="l", caption="\\label{tab:marfis_SAR_record_table}Quality Tier: Medium. Security level: Protected B. Maritimes Fishery Information System (MARFIS) observation records of species contained within the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listings <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>", booktabs = T, escape = F, linesep="") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
kable(marfis_freq_table, caption="\\label{tab:marfis_freq_table}Quality Tier: Medium. Security level: Protected B. Maritimes Fishery Information System (MARFIS) observation records of <u>all species</u> contained within the search area, summarized by species or species group. <b>The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>", booktabs = T, escape = F, linesep="") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

### **Ocean Biodiversity Information System (OBIS)**    
Contact: helpdesk@obis.org  
Last retrieved on: January 27, 2021 from [OBIS](https://obis.org/)  
Quality Tier: Medium  
Search year: 2002-2020  
Security level: none  

#### ***Area-specific OBIS fish and invertebrate search results***    
```{r, include=FALSE, cache=FALSE}
#Select columns of interest from OBIS file
obis_edit<-obis %>% 
  transmute(scientificName, decimalLatitude, decimalLongitude, year,individualCount, rightsHolder, institutionID, institutionCode, collectionCode, datasetID)
 
#Delete WSDB and CWS/ECCC records
obis_edit2<-obis_edit %>%
  filter(! institutionCode =="Canadian Wildlife Service-Atlantic, Environment and Climate Change Canada")
obis_edit3<-obis_edit2 %>%
  filter(! collectionCode =="WHALESITINGS")
obis_sf<-st_as_sf(obis_edit3, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)
intersect_obis <- st_intersection(obis_sf,PEZ_poly_st)

#append columns from listed species
intersect_obis<- intersect_obis %>% rename(Scientific_Name=scientificName)
obis_fish_table<-merge(intersect_obis, listed_fish_invert_species, by='Scientific_Name')
intersect_obis_fish_sep <- obis_fish_table %>%
    mutate(long = unlist(map(obis_fish_table$geometry,1)),
           lat = unlist(map(obis_fish_table$geometry,2)))
Total_number_SAR_records_obis<-as.numeric(nrow(obis_fish_table))
obis_fish_table<-obis_fish_table %>% select(Common_Name, Scientific_Name, Schedule.status, COSEWIC.status, Wild_Species)
obis_fish_table<- obis_fish_table %>% rename("SARA status"=Schedule.status,
                                             "COSEWIC listing"=COSEWIC.status,
                                             "Wild Species listing"=Wild_Species,
                                             "Scientific Name"=Scientific_Name,
                                             "Common Name"=Common_Name)
obis_fish_table$geometry<-NULL
obis_fish_table<-unique(obis_fish_table)
```

*
```{r, echo=FALSE, results='asis',}
Report_obis<-if(Total_number_SAR_records_obis < 1){
  "There are no relevant records in the Ocean Biodiversity Information System (OBIS) for this search area."
} else {
  "There are relevant records in the Ocean Biodiversity Information System (OBIS) for this search area."
}
Report_obis2<-noquote(Report_obis)
writeLines(c(Report_obis2), sep = "\n")
```

```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: Medium. Security level: none. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query information from Ocean Biodiversity Information System (OBIS) observation records, for species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. Sightings on land are an indicator that the sighting data have not yet been completely error-checked or that animals were sighted from shore. The absence of a species in this figure should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.'}
par(mfrow = c(1,2), mar=c(0, 0, 5.5, 0) + 2)#it goes c(bottom, left, top, right)
obis_plot<-site_map(PEZ_poly,PEZ_poly_st,site_sf,land_sf,5)+
  geom_point(data = intersect_obis_fish_sep, aes(x = long, y = lat), size = 3, 
        shape = 16, fill = "black") 
if(Total_number_SAR_records_obis > 1){print(obis_plot)}

```

```{r echo=FALSE, results='asis', caption="Priority species with observations contained in the OBIS database within the search polygon area."}
OBIS_query_output_table<-if(Total_number_SAR_records_obis < 1){
  ""
} else {
  kable(obis_fish_table, align="l", row.names = F, caption="\\label{tab:obis_fish_table}Quality Tier: Medium. Security level: none. Ocean Biodiversity Information System (OBIS) observation records of species contained within the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild Species listing. <b>The absence of a species in this figure should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b>",
        booktabs = T, escape = F, linesep="") %>%
    kable_styling(bootstrap_options = "striped", full_width = T, position = "left")}
if(Total_number_SAR_records_obis > 1){OBIS_query_output_table}
```
