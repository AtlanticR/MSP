---
title: "Reproducible Report for Species in Maritimes Region - for Internal DFO use only"
author: Synthesis prepared by the Reproducible Reporting Team, steering committee and advisors.
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    theme: paper
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---
```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
library(Mar.datawrangling)
library(Mar.utils)
library(knitr)
library(kableExtra)
library(rgdal)
library(maps)
library(lubridate)
library(raster)
library(RCurl)
library(sf)
library(stringr)
library(ggplot2)
library(data.table)
library(gridExtra)
library(dplyr)
library(stars)
library(ggspatial)
library(tidyverse)
```
```{r source functions, include=FALSE, cache=FALSE}
# the .Rmd file sets the working directory based on where it resides and ignores the wd set by the .RProj file
source("site_map.r")
source("site_map_new.r")
source("filter_wsdb.r")
```
```{r Define Site, include=FALSE, cache=FALSE}
AquaSiteName <- "FarmersLedge"
PEZversion <- "4748m"
UserComments <- "Example - First search effort for suitability of a site for a project planned for 2025. Project is expected to have positive/negative impacts on surrounding area. It is likely that some kind of monitoring will be required during operations. Make sure to follow up on all sections pertaining to a particular taxonomic group as this seems to be a concern of the stakeholders."
#make sure you delete all shp.xml files in the folder to be able to run this code
minYear <- 1970
maxYear <- 2020
```
```{r Set up paths, include=FALSE, cache=FALSE}
mspPath <- "../"
data.dir = "../../../Data/mar.wrangling"
#create a folder in outputs with the name of the site and buffer area search
dataPath <- file.path("../../../Data/outputs",paste0(AquaSiteName,PEZversion))
# setwd(dataPath) #not needed?
polyPath <- "../../../Data/Zones/SearchPEZpolygons"
site <- readOGR(polyPath,layer=paste0("Site_",AquaSiteName))
site_sf <- st_as_sf(site)
```
```{r read baseline data for maps, include=FALSE, cache=FALSE}
landGDB <- "../../../Data/Boundaries/Coast50K/Coastline50k.gdb"
land <- readOGR(dsn=landGDB,layer="Land50k_Maritimes",stringsAsFactors=F)
land_sf <- st_as_sf(land)
```
```{r Define PEZ!, include=FALSE, cache=FALSE}
pl <- list.files(polyPath,"*.shp")
pl <- pl[-grep("xml",pl)]
PEZ_poly <- readOGR(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]))
#PEZ_poly_st<-st_read(../../../Data/Zones/SearchPEZpolygons/PEZ_TestGullyPolygon.shp", quiet=TRUE)
PEZ_poly_st<-st_as_sf(PEZ_poly)
```
```{r Species listed by Wildspecies, COSEWIC and SARA in the Maritime Region, include=FALSE, cache=FALSE}

listed_species<-read.csv("../../../Data/NaturalResources/Species/MAR_listed_species.csv")
MARSAR_com <- listed_species$Common_Name
MARSAR_com_up <- listed_species$Common_Name_upper
MARSAR_sci <- listed_species$Scientific_Name
MARSAR_sci_up <- listed_species$Scientific_Name_upper
```

# **Search Results for Species at Risk**  

## **Cetacean Section**

wsdbFile <- file.path("../../../Data/NaturalResources/Species/Cetaceans/WSDB","MarWSDBSightingsForCGomez_27Oct2020.csv")
wsdb <- read.csv(wsdbFile)
wsdb <- wsdb[which(wsdb$YEAR>=minYear),]
```
#### **Whale Sightings Database (WSDB)**  
Contact: XMARWhaleSightings@dfo-mpo.gc.ca  
Last retrieved on: October 27 2020  
Tier of confidence: **Low**  
Search year:  

```{r read wsdb and filter SARA & COSEWIC cetacean spp, include=FALSE, cache=FALSE}
wsdb_filter <- filter_wsdb(wsdb)
wsdb_filter <- wsdb_filter %>% rename(Scientific_Name = SCIENTIFICNAME)
wsdb_filter <- merge(wsdb_filter, listed_species, by='Scientific_Name')
```

```{r echo=FALSE, results='asis'}
wsdb_plot_locations<-st_as_sf(wsdb_filter, coords = c("LONGITUDE", "LATITUDE"), crs = 4326)
intersect_wsdb <- st_intersection(wsdb_plot_locations,PEZ_poly_st)
x<-as.numeric(nrow(intersect_wsdb))
Common_Name<-intersect_wsdb$Common_Name
Scientific_Name<-intersect_wsdb$Scientific_Name
intersect_wsdb_df<-as.data.frame(cbind(Common_Name, Scientific_Name, row.names = FALSE))

#append columns from listed species 
wsdb_table<-merge(intersect_wsdb_df, listed_species, by='Scientific_Name')
wsdb_table2<-wsdb_table %>% 
  transmute(Common_Name, Scientific_Name, Schedule.status, COSEWIC.status, Wild_Species)
wsdb_table3<- wsdb_table2 %>% rename(SARA_listing=Schedule.status,
                                     COSEWIC_listing=COSEWIC.status,
                                     Wild_Species_listing=Wild_Species 
                                     )
Query_output_wsdb<-if(x < 1){
  "There are no records in the WSDB for this search area."
} else {
  "The WSDB contains records of whales in this search area."
}
Query_output_wsdb2<-noquote(Query_output_wsdb)
writeLines(c(Query_output_wsdb2), sep = "\n")
```

```{r echo=FALSE, results='asis'}
WSDB_query_output_table<-if(x < 1){
  ""
} else {
  kable(wsdb_table3[!duplicated(wsdb_table3),], row.names=F, caption="Cetaceans with observations contained in the WSDB within the search polygon area.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}
WSDB_query_output_table
```

```{r Fig 3 Whale Sightings Database, fig.height=8, fig.width=11, fig.cap="The tier of confidence of this map for internal use only is **Low**. Map represents cetacean sightings from the Whale Sightings Database (WSDB) (including sightings of groups of animals) in the search area. Absence of a species in the map should be interpreted as an absence of reporting, not as an absence of the species in the area (e.g. sightings information underrepresents presence of cetaceans as this search does not include acoustic detections). Sightings on land are an indicator that the sighting data have not yet been completely error-checked."}
par(mfrow = c(1,2), mar=c(0, 0, 5.5, 0) + 2)#it goes c(bottom, left, top, right)
wsdb_plot<-site_map_new(PEZ_poly,PEZ_poly_st,site_sf,land_sf,5)+
  geom_point(data = wsdb_filter, aes(x = LONGITUDE, y = LATITUDE, color=Common_Name), 
             size = 3.5)
print(wsdb_plot + scale_colour_manual(values=c("darkgoldenrod1", "chartreuse4", "black", "#00AFBB","#B337A3", "#0827EF", "#EF6408", "#F5A4E7")))

```

