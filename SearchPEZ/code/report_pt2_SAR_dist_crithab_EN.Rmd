```{r load packages, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
library(easypackages)
libraries("Mar.datawrangling","knitr","kableExtra","rgdal","maps","lubridate","raster","RCurl","sf","stringr","ggplot2","data.table","gridExtra","dplyr",
          "stars","ggspatial","tidyverse","standardPrintOutput")
```
```{r load source functions, include=FALSE, cache=FALSE}
source("site_map.r")
source("site_map_new.r")
source("filter_wsdb.r")
source("filter_narwc_new.r")
source("EBSA.R")
source("leatherback.R")
source("cetacean_priority_areas.R")
source("Blue_Whale_habitat.R")
source("fn_SearchRVData.r")
source("fn_Search_ISDB_Data.r")
source("fn_maps.r")
source("fn_Search_MARFIS_Data.r")
```
```{r Define Site, include=FALSE, cache=FALSE}
AquaSiteName <- "FarmersLedge"
PEZversion <- "4748m"
minYear <- 2002
```
```{r set up paths, include=FALSE, cache=FALSE}
mspPath <- "../"
data.dir = "../../../Data/mar.wrangling"
dataPath <- file.path("../../../Data/outputs",paste0(AquaSiteName,PEZversion))
polyPath <- "../../../Data/Zones/SearchPEZpolygons"
site <- readOGR(polyPath,layer=paste0("Site_",AquaSiteName))
site_sf <- st_as_sf(site)
land_sf<-st_read("../../../Data/Boundaries/Coast50K/Coastline50k_SHP/Land_AtlCanada_ESeaboardUS.shp", quiet=TRUE)
pl <- list.files(polyPath,"*.shp")
pl <- pl[-grep("xml",pl)]
PEZ_poly <- readOGR(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]))
PEZ_poly_st<-st_as_sf(PEZ_poly)
```
```{r load SAR species lists, include=FALSE, cache=FALSE}
listed_species<-read.csv("../../../Data/NaturalResources/Species/MAR_listed_species.csv")
cetacean_list<-c("Beluga Whale", "Humpback Whale" , "North Atlantic Right Whale", "Fin Whale", "Northern Bottlenose Whale", "Harbour Porpoise", "Killer Whale", "Blue Whale", "Sei Whale", "Sowerby's Beaked Whale")
other_species_list<-c("Loggerhead Sea Turtle", "Atlantic Walrus", "Harbour Seal Lacs des Loups Marins subspecies", "Leatherback Sea Turtle")
listed_cetacean_species<-subset(listed_species, Common_Name %in% cetacean_list)
listed_other_species<-subset(listed_species, Common_Name %in% other_species_list)
listed_fish_invert_species<-listed_species[ ! listed_species$Common_Name %in% c(other_species_list,cetacean_list), ]
```

# **Search Results:**
## **EMPHASIS ON SPECIES LISTED BY THE SPECIES AT RISK ACT, ASSESSED BY COSEWIC AND/OR WILD SPECIES  (Table x)**  

```{r echo=FALSE, results='asis'}
List_table<-data.frame("Document/Organization"="", Description = "")
List_table[1,1]<-"SARA"
List_table[2,1]<-"COSEWIC"
List_table[3,1]<-"Wild Species"
List_table[1,2]<-"The Species at Risk Act (SARA) was proclaimed in June 2003, and is one part of a three part Government of Canada strategy for the protection of wildlife species at risk. This three part strategy also includes commitments under the Accord for the Protection of Species at Risk and activities under the Habitat Stewardship Program for Species at Risk. The purposes of SARA are to prevent Canadian indigenous species, subspecies, and distinct populations from becoming extirpated or extinct, to provide for the recovery of endangered or threatened species, and encourage the management of other species to prevent them from becoming at risk. It applies to all federal lands in Canada; all wildlife species listed as being at risk; and their critical habitat. For more information on SARA visit <https://www.canada.ca/en/environment-climate-change/services/species-risk-public-registry.html>"
List_table[2,2]<-"The Committee on the Status of Endangered Wildlife in Canada (COSEWIC) is an independent advisory panel to the Minister of Environment and Climate Change Canada that meets twice a year to assess the status of wildlife species at risk of extinction. Members are wildlife biology experts from academia, government, non-governmental organizations and the private sector responsible for designating wildlife species in danger of disappearing from Canada. COSEWIC determines the national status of wild Canadian species, subspecies, varieties or other designatable units that are suspected of being at risk of extinction or extirpation. COSEWIC uses a process based on science and Aboriginal or community knowledge to assess wildlife species at risk. All native mammals, birds, reptiles, amphibians, fish, arthropods, molluscs, vascular plants, mosses and lichens are included in COSEWIC's current mandate.
For more information on COSEWIC visit <https://www.cosewic.ca/index.php/en-ca/>"
List_table[3,2]<-"Every five years the National General Status Working Group (NGSWG), which includes representatives from all provincial and territorial governments in Canada, and from the federal government, publishes a general report on the status of wildlife species in Canada. 
The following text is verbatim from the Wildlife website (URL below).These reports are meant to inform Canadians about the status of species in the country, and to help prevent species in Canada from becoming extinct as a consequence of human activity.
For more information about Wild Species reports visit <https://www.wildspecies.ca/home>"
List_table<- List_table %>% rename("Document / Organization"=Document.Organization)
```
```{r}
kable(List_table, align="l", caption = "Definitions relevant for species listed by Species At Risk Act (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or assessed for Wild Species listings.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

## **Information from National Aquatic Species at Risk Program**  

The official source of information for Species at Risk is the Species at Risk Public Registry <http://www.sararegistry.gc.ca>.
DFO Species at Risk program is responsible for carrying out DFO’s mandate under the Species at Risk Act (SARA) and is an authoritative source of information for Aquatic Species at Risk.
DFO Species at Risk program has published Species at Risk distribution/range and critical habitat maps on the Government of Canada Open Data portal, and has also developed internal and public interactive National Species at Risk Mapping Tools. As described by the National Species at Risk Mapping Tool - Frequently Asked Question <http://dfonl7swvgip001/NationalSARDemo/LinkDocs/Help/FAQsEN_FR.pdf>, the Species at Risk Program in NHQ initiated the tool to facilitate project assessment under the Fisheries Act and the SARA. It uses a Geographic Information System (GIS) and interactive display of reproducible, spatially referenced data of aquatic Species at Risk listed species. The data contained in the tool is maintained by regional Species at Risk program offices, coordinated by the NHQ Species at Risk Program (Steering Committee). Data is added in concert with the Recovery Plan and SARA listing timelines.
This section of the report simply provides a first examination of the data products available in the Species At Risk internal GIS tool that may overlap with the search area. Importantly, this document is not the authoritative advice for Species At Risk data. Please access the Species At Risk GIS tool to create the authoritative report, particularly if any of the data sources are at or near the search area.

### **Species At Risk Distribution and Critical Habitat data**  

#### **DFO Species At Risk distribution (range)**  
Contact: <info@dfo-mpo.gc.ca>  
Link: <https://open.canada.ca/data/en/dataset/e0fabad5-9379-4077-87b9-5705f28c490b> Last retrieved on: October 1 2020 from Open Data  
Quality Tier: High  
Security level: none  

The Species at Risk Program is responsible for carrying out DFO’s mandate under the Species at Risk Act (SARA) to protect, recover and conserve all listed aquatic Species at Risk in Canada. As part of this mandate, this spatial database has been developed to identify areas in which aquatic species listed under SARA may be found. Distribution and range information are identified for species listed as Endangered, Threatened or Special Concern under SARA. Distribution (range) polygons and lines were assembled by regional SARA biologists using the best available information, including COSEWIC status reports, recovery potential assessments, academic literature, and expert opinion. These spatial data support the protection, recovery and conservation of species listed as Endangered, Threatened or Special Concern under SARA. Species distributions are also described and displayed in Recovery Strategies, Action Plans and/or Management Plans. Discrepancies may exist between the distribution data shown in a species’ SARA recovery document and the current spatial data. Please contact DFO for more information on any data discrepancies.  

#### **Critical Habitat of Species At Risk**  
Contact: <info@dfo-mpo.gc.ca>  
Link: <https://open.canada.ca/data/en/dataset/db177a8c-5d7d-49eb-8290-31e6a45d786c>  
Last retrieved on: October 1 2020 from Open Data  
Quality Tier: High  
Security level: none  

The Species at Risk Program is responsible for carrying out DFO’s mandate under the Species at Risk Act (SARA) to protect, recover and conserve all listed aquatic Species at Risk in Canada. Critical habitat is identified for species listed as Endangered or Threatened under the Species at Risk Act (SARA). Critical habitat is defined under section 2 of SARA as: “the habitat that is necessary for the survival or recovery of a listed wildlife species and that is identified as the species’ critical habitat in the recovery strategy or in an action plan for the species”. Section 49(1)(a) of SARA requires that a species’ Recovery Strategy/Action Plan include an identification of the species’ critical habitat to the extent possible, based on the best available information, including information provided by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC). SARA makes it illegal to destroy any part of the critical habitat of SAR and may impose restrictions on development and construction. Critical habitats were assembled by SARA regional biologists and recovery teams. They are designed to support the protection and recovery of species listed as Endangered or Threatened under the Species at Risk Act. They are also described and displayed in species’ Recovery Documents and Action Plans.  

```{r Set up paths for National Aquatic Species at Risk Section, include=FALSE, cache=FALSE}
fl <- list.files(dataPath,".csv")
ClippedCritHab <- st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/ClipCritHab.shp", quiet=TRUE)
sardist<-st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/sardist_4326.shp", quiet=TRUE)
leatherback_shp<-st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/LeatherBackTurtleCriticalHabitat/LBT_CH_2013.shp", quiet=TRUE)
```

#### **Draft Critical Habitat for Leatherback Sea Turtle - In Review**  
Contact: info@dfo-mpo.gc.ca  
**URL:** <http://dfonl7swvgip001.ent.dfo-mpo.ca/Html5Viewer/index.html?viewer=NationalSARMap_EN&LayerTheme=0&locale=en-US#>  
Last retrieved on: xxx  
Quality Tier: Very High  

Please read the section above about the definition of Critical Habitat under the Species at Risk Act (SARA). Draft Critical Habitat for Leatherback Sea Turtle - in review - is available in the internal Species At Risk <a href="http://dfonl7swvgip001.ent.dfo-mpo.ca/Html5Viewer/index.html?viewer=NationalSARMap_EN&LayerTheme=0&locale=en-US">GIS tool</a> and will be available in Open Data in the future.

#### **Area-specific SAR distribution and critical habitat search results**

```{r echo=FALSE, results='asis'}
intersect_dist <- st_intersection(sardist,PEZ_poly_st)
intersect_dist$Common_Nam[intersect_dist$Common_Nam == "Sowerby`s Beaked Whale"] <- "Sowerby's Beaked Whale"
Common_Name<-intersect_dist$Common_Nam
Scientific_Name<-intersect_dist$Scientific
Population<-intersect_dist$Population
Area<-intersect_dist$Waterbody
intersect_dist_df<-as.data.frame(cbind(Common_Name, Scientific_Name, Population, Area))

#append columns from listed species 
dist_table<-merge(intersect_dist_df, listed_species, by='Scientific_Name')
x<-as.numeric(nrow(dist_table))
dist_table2<-dist_table %>% 
  transmute(Common_Name, Scientific_Name, Population, Area, Schedule.status, COSEWIC.status, Wild_Species)
dist_table3<- dist_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                     "Common Name"=Common_Name,
                                     "Scientific Name"=Scientific_Name)
Query_output_dist<-if(x < 1){
  "The provided polygon does not overlap with species at risk distribution range."
} else {
  "The provided polygon overlaps with species at risk distribution range."
}
Query_output_dist2<-noquote(Query_output_dist)

writeLines(c(Query_output_dist2), sep = "\n")
```

```{r echo=FALSE, results='asis'}
Query_output_table<-if(x < 1){
  ""
} else {
  kable(dist_table3[!duplicated(dist_table3),], caption= "Quality Tier: High. Security level: none. Species At Risk listed as Endangered, Threatened or Special Concern under the Species At Risk Act for which the search polygon overlaps with their distribution (range). This is not the authoritative source or advice for Species At Risk data. Please access the Species At Risk GIS tool to create the authoritative SARA report.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}

if(x > 1){Query_output_table}

```

#### **Species at Risk Critical Habitat Search Results**

```{r echo=FALSE, results='asis'}
intersect <- st_intersection(ClippedCritHab,PEZ_poly_st)
x<-as.numeric(nrow(intersect))
CommonName<-intersect$Common_Nam
Population<-intersect$Population
Area<-intersect$Waterbody
SARA_status<-intersect$SARA_Statu
intersect_df<-data.table(expand.grid(CommonName = CommonName, Population = Population, Area=Area, SARA_status=SARA_status))
Query_output_crit<-if(x < 1){
  "The provided polygon does not overlap with defined critical habitat."
} else {
  "The provided polygon overlaps with Critical Habitat."
}

Query_output_crit2<-noquote(Query_output_crit)

writeLines(c(Query_output_crit2), sep = "\n")
```
```{r echo=FALSE, results='asis'}
Query_output_table<-if(x < 1){
  ""
} else {
  kable(intersect_df[!duplicated(intersect_df),], caption="Quality Tier: High. Security level: none. Species At Risk listed as Endangered or Threatened under the Species At Risk Act (SARA) for which the search polygon overlaps with their critical habitat. Critical habitat is defined under section 2 of SARA as: “the habitat that is necessary for the survival or recovery of a listed wildlife species and that is identified as the species’ critical habitat in the recovery strategy or in an action plan for the species”. Critical Habitat is identified in a species’ recovery strategy or action plan, posted on the SAR Public Registry (www.sararegistry.gc.ca). This is not the authoritative source or advice for Species At Risk data. Please access the Species At Risk GIS tool to create the authoritative SARA report.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}
Query_output_table2<-noquote(Query_output_table)

if(x > 1){print(Query_output_table2)}
```

```{r Fig X PEZ polygon with all maritime Critical Habitat polygons, fig.height=8, fig.width=11, fig.cap="Quality Tier: High. Security level: none. This map summarizes areas where the search polygon overlaps with critical habitat of Species At Risk listed as Endangered or Threatened under the Species At Risk Act (SARA). Critical habitat is defined under section 2 of SARA as: “the habitat that is necessary for the survival or recovery of a listed wildlife species and that is identified as the species’ critical habitat in the recovery strategy or in an action plan for the species”. Critical Habitat is identified in a species’ recovery strategy or action plan, posted on the SAR Public Registry (www.sararegistry.gc.ca). This is not the authoritative source or advice for Species At Risk data. Please access the Species At Risk GIS tool to create the authoritative report."}
plot_crithab(ClippedCritHab, PEZ_poly_st, land_sf)

```

```{r Fig X close up of PEZ polygon, fig.height=8, fig.width=11, fig.cap="Zoomed view of figure above."}
plot_crithab_zoom(ClippedCritHab, PEZ_poly_st, land_sf)
```

#### **Draft: Leatherback Search Results**  

```{r echo=FALSE, results='asis'}
#function for overlap
leatherback_overlap(leatherback_shp=leatherback_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for sector
leatherback_area(leatherback_shp=leatherback_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r Fig X PEZ polygon with all maritime leatherback polygons, fig.height=8, fig.width=11, fig.cap="Map showing Leatherback Sea Turtle Important Habitat (green) relative to the defined Potential Exposure Zone (PEZ; blue) and proposed project polygon (yellow)."}
plot_leatherback(leatherback_shp, PEZ_poly_st, land_sf)
```