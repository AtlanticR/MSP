```{r load packages, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
library(easypackages)
libraries("Mar.datawrangling","knitr","kableExtra","rgdal","maps","lubridate","raster","RCurl","sf","stringr","ggplot2","data.table","gridExtra","dplyr",
          "stars","ggspatial","tidyverse","standardPrintOutput")
```
```{r load source functions, include=FALSE, cache=FALSE}
source("site_map.r")
source("site_map_new.r")
source("filter_wsdb.r")
source("filter_narwc_new.r")
source("EBSA.R")
source("leatherback.R")
source("cetacean_priority_areas.R")
source("Blue_Whale_habitat.R")
source("fn_SearchRVData.r")
source("fn_Search_ISDB_Data.r")
source("fn_maps.r")
source("fn_Search_MARFIS_Data.r")
```
```{r Define Site, include=FALSE, cache=FALSE}
AquaSiteName <- "FarmersLedge"
PEZversion <- "4748m"
minYear <- 2002
```
```{r set up paths, include=FALSE, cache=FALSE}
mspPath <- "../"
data.dir = "../../../Data/mar.wrangling"
dataPath <- file.path("../../../Data/outputs",paste0(AquaSiteName,PEZversion))
polyPath <- "../../../Data/Zones/SearchPEZpolygons"
site <- readOGR(polyPath,layer=paste0("Site_",AquaSiteName))
site_sf <- st_as_sf(site)
land_sf<-st_read("../../../Data/Boundaries/Coast50K/Coastline50k_SHP/Land_AtlCanada_ESeaboardUS.shp", quiet=TRUE)
pl <- list.files(polyPath,"*.shp")
pl <- pl[-grep("xml",pl)]
PEZ_poly <- readOGR(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]))
PEZ_poly_st<-st_as_sf(PEZ_poly)
```
```{r load SAR species lists, include=FALSE, cache=FALSE}
listed_species<-read.csv("../../../Data/NaturalResources/Species/MAR_listed_species.csv")
cetacean_list<-c("Beluga Whale", "Humpback Whale" , "North Atlantic Right Whale", "Fin Whale", "Northern Bottlenose Whale", "Harbour Porpoise", "Killer Whale", "Blue Whale", "Sei Whale", "Sowerby's Beaked Whale")
other_species_list<-c("Loggerhead Sea Turtle", "Atlantic Walrus", "Harbour Seal Lacs des Loups Marins subspecies", "Leatherback Sea Turtle")
listed_cetacean_species<-subset(listed_species, Common_Name %in% cetacean_list)
listed_other_species<-subset(listed_species, Common_Name %in% other_species_list)
listed_fish_invert_species<-listed_species[ ! listed_species$Common_Name %in% c(other_species_list,cetacean_list), ]
```
```{r load data sets used by multiple sections, include=FALSE, cache=FALSE}
obis<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/OBIS_MAR_priority_records.csv")
obis<-subset(obis,year>minYear)
```

## **Fish and Invertebrates**

```{r read fish and invertebrate files, include=FALSE, cache=FALSE}
fl <- list.files(dataPath,".csv")
cws<-read.csv("../../../Data/NaturalResources/Species/CWS_ECCC/CWS_ECCC_OBIS_records.csv")
cws<-subset(cws,year>minYear)
inat<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/iNaturalist_MAR_priority_records.csv")
inat<-subset(inat,datetime>minYear)
gbif<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/GBIF_MAR_priority_records.csv")
gbif<-subset(gbif,year>minYear)
```

### **Maritimes Research Vessel (RV) Survey**   

Contact: <DFO.MAR-PED-Data-Request-Demande-de-donnes-DEP-MAR.MPO@dfo-mpo.gc.ca>  
Last retrieved on: January 21, 2021 from Open Data <https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b>  
Quality Tier: **High**  
Search year: 1970-2020  
Security level: none  

```{r echo=FALSE, results='asis'}
cat("Time frame:", "insert results from min and max year search function for this db.")
```

The Fisheries and Oceans Canada ecosystem surveys are conducted annually and are a source of integrated ecosystem monitoring data. These survey data are the primary data source for monitoring trends in species distribution, abundance, and biological condition within the region, and also provide data to the Atlantic Zonal Monitoring Program (AZMP) for monitoring hydrographic conditions, along with zooplankton and phytoplankton. The surveys follow a stratified random sampling design, and include sampling using a bottom otter trawl, CTD rosette and vertical plankton tows. Data from the bottom trawl catch are used to monitor the distribution and abundance of fish and invertebrates throughout the Scotian Shelf, Bay of Fundy and Georges Bank.  
Note: Users are advised to use several years worth of data as sampling can be patchy and inconsistent from one year to the next. Also, sampling methods were modified throughout the decades, so there can be sudden changes in species diversity over time.  

```{r echo=FALSE, results='asis'}
RV_surveys_table<-data.frame(Survey="", "Season/Months" = "", "Description of Geographic Range" = "", "Bounding Box" = "")
RV_surveys_table[1,1]<-"4VSW*"
RV_surveys_table[2,1]<-"Fall"
RV_surveys_table[3,1]<-"Spring"
RV_surveys_table[4,1]<-"Summer"
RV_surveys_table[1,2]<-"Primarily in March, but sets in both  February, and April are also present in the data."
RV_surveys_table[1,3]<-"Eastern half of the Scotian Shelf."
RV_surveys_table[1,4]<-"SW: -63.33 42.79, NE: -56.32 45.67"
RV_surveys_table[2,2]<-"Primarily in October and November, but sets from September and December are also present in the data."
RV_surveys_table[2,3]<-"Gulf of Maine and Bay of Fundy, Scotian Shelf, Laurentian Channel"
RV_surveys_table[2,4]<-"SW: -70 40, NE: -56 47.5"
RV_surveys_table[3,2]<-"January, February, March and April"
RV_surveys_table[3,3]<-"Focuses mainly in Georges Bank (NAFO Division 5Z)."
RV_surveys_table[3,4]<-"SW: -70 40, NE: -56 47.5"
RV_surveys_table[4,2]<-"May, June, July and August."
RV_surveys_table[4,3]<-"Scotian Shelf and Bay of Fundy (NAFO Divisons 4VWX5Yb, expanding recently to include the Laurentian Channel and Georges Bank (5Zc)."
RV_surveys_table[4,4]<-"SW: -70 40, NE: -56 47.5"
RV_surveys_table<- RV_surveys_table %>% rename("Season/Months" = Season.Months,
                                               "Description of Geographic Range" = Description.of.Geographic.Range,
                                               "Bounding Box" = Bounding.Box)
```
```{r}
kable(RV_surveys_table, align="l", caption="The RV survey data set consists of data collected during the following 4 separate annual surveys:") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
*These missions use a unique stratification scheme intended to optimize the abundance estimates of cod.

For more information on RV survey data visit: <https://waves-vagues.dfo-mpo.gc.ca/Library/4062092x.pdf>

### **Industry Survey Database (ISDB)**  
Contact: <Claire.Mussells@dfo-mpo.gc.ca>  
Last retrieved on: 2019  
Quality Tier: **Medium**  
Search year: 2002-2019  
Security level: Protected B  

```{r echo=FALSE, results='asis'}
cat("Time frame:", "insert results from min and max year search function for this db.")
```

The Industry Survey Database (ISDB) is a DFO database that contains at-sea fish catch observations from commercial fishing vessels operating in the North West Atlantic. The data provided by ISDB is confidential and cannot be communicated outside of the DFO, given the direct implications of the Rule of 5. Industry surveys do not fully sample the region spatially or temporally and, therefore, additional information on presence and habitat use (i.e. spawning, migration, feeding) must be drawn from larger-scale studies.

Reminder: fisheries catch and effort information for an individual licence holder, is considered personal information and is protected under section 19 of the Access to Information Act <https://laws-lois.justice.gc.ca/eng/acts/a-1/page-5.html#h-12>, and for a corporate licence holder, is considered to be sensitive, proprietary information and protected under Section 20 of the Access to Information Act <https://laws-lois.justice.gc.ca/eng/acts/a-1/page-5.html#h-13>

Without written consent, DFO is not permitted to release information or data products (e.g., maps and data layers) that might reveal personal or third party information such as catch, landed values, and vessel-specific fishing locations. This information is also available in the DFO staff informal release guidelines (i.e. Appendix B – “Catch and Effort and Quota Information: Do’s and Don’ts for Informal Release” <\ent.dfo-mpo.caInformation_Release_Guidelines-eng.docx>).

### **The Maritime Fishery Information System (MARFIS)**  
Contact: <XMARComData@dfo-mpo.gc.ca>  
```{r echo=FALSE, results='asis'}
info<-file.info("../../../Data/mar.wrangling/MARFIS.PRO_SPC_INFO.RData")
LatestUpdate<-format(info[,"mtime"], format = "%B %d %Y")
last_retrieved<-c("Last retrieved on: ",LatestUpdate)
writeLines(c("Last retrieved on:",LatestUpdate), sep = " ")
```
Quality Tier: **Medium**  
Search year: 2002-2019  
Security level: Protected B  
 
```{r echo=FALSE, results='asis'}
cat("Time frame:", "insert results from min and max year search function for this db.")
```

The Maritime Fishery Information System (MARFIS) is a DFO database, managed by the Policy & Economics Branch. MARFIS contains: catch and effort, quota, and licensing information for the Maritimes region. The catch and effort data contains the log information for all commercial fisheries that land within this region. If a Maritimes region commercial vessel lands in another DFO region or outside of Canadian waters, it is not included in the database. The majority of catch information is related to commercial offloads. MARFIS does not fully sample the region spatially or temporally and, therefore, additional information on presence and habitat use (i.e. spawning, migration, feeding) must be drawn from larger-scale studies. There is also more limited data related to discards and the SARA log. Not all catch records have associated lat/long coordinates. This may be due to the structure of the log itself, or missing data. Generally all records have a NAFO Division and NAFO Unit Area flag, even if no coordinates have been provided. Data for the years 2017-2020 is preliminary and subject to change without notice. There may be some limited changes to data in the years 2016 and previous. Ongoing qa/qc work is done on the MARFIS database, but not all errors are corrected. If you have data errors, questions, or corrections, you can send them to our data quality inbox: CDDDataQuality@dfo-mpo.gc.ca. Requests for data exports can be sent to: XMARComData@dfo-mpo.gc.ca. This information about MARFIS was provided by Colin.O'Neil@dfo-mpo.gc.ca (July 2020, Policy & Economics Branch).  
Should you receive a request for ISDB and MARFIS, please just forward to Peter Comeau and <XMARComData@dfo-mpo.gc.ca>, respectively. Please feel free to use the email template below. Note that the template includes an attachment which you can download here - Informal Release Guidelines <\\ent.dfo-mpo.ca\ATLShares\Shared\ATIP Information\Informal_Release_Guidelines-eng.docx>.

### **Ocean Biodiversity Information System (OBIS)**  
Contact: <helpdesk@obis.org>  
URL: <https://obis.org/>  
Last retrieved on: January 27 2021 from OBIS  
Quality Tier: **Medium**  
Search year: xxxx  
Security level: none  

```{r echo=FALSE, results='asis'}
cat("Time frame:", "insert results from min and max year search function for this db.")
```

OBIS is a global open-access data and information clearing-house on marine biodiversity for science, conservation and sustainable development. Their vision is to build and maintain a global alliance that collaborates with scientific communities to facilitate free and open access to, and application of, biodiversity and biogeographic data and information on marine life. OBIS search was conducted to find additional relevant records for listed by SARA, or assessed by COSEWIC and Wild species listing. Future iterations of this reporting tool will aim at expanding our quality checks of the OBIS database.

#### **iNaturalist**
Contact:   
Site:   
Last retrieved on:   
Quality Tier:  
Search year:  
```{r echo=FALSE, results='asis'}
cat("Time frame:", "insert results from min and max year search function for this db.")
```

#### **Global Biodiversity Information Facility (GBIF)**
Contact:   
Site:   
Last retrieved on:   
Quality Tier:  
Search year:  
```{r echo=FALSE, results='asis'}
cat("Time frame:", "insert results from min and max year search function for this db.")
```

#### **Passamaquoddy Biodiversity Trawl**
Contact:   
Site:   
Last retrieved on:   
Quality Tier:  
Search year:  
```{r echo=FALSE, results='asis'}
cat("Time frame:", "insert results from min and max year search function for this db.")
```

The Coastal Biodiversity Trawl Survey for the Passamaquoddy Bay was conducted annually between July to October from 2009 to 2019. This survey was intended to monitor long-term change in local species presence, habitat utilization, and health. The sampling activities support coastal research in fisheries, aquaculture, marine protected areas, and ecosystem change. Data collected prior to 2013 are generally not recommended for comparative analysis due to changes in vessel, sampling effort, and protocols.

#### **Area-specific Maritimes Research Vessel (RV) Survey search results**
```{r, include=FALSE, cache=FALSE}
SurveyPrefix <- c("4VSW", "FALL", "SPRING", "SUMMER")
File <- c("_2020_GSCAT.csv", "_2020_GSINF.csv", "_2020_GSSPECIES.csv")
RVCatch <-  SelectRV_fn(SurveyPrefix, File, AquaSiteName, PEZversion, minYear)
RVCatch$database<-"rv"
rv_freq <- aggregate(
        x = list(Records = RVCatch$COMM),
      by = list(Scientific_Name = RVCatch$SPEC, Common_Name=RVCatch$COMM, Individuals=RVCatch$TOTNO, Set_No=RVCatch$SETNO
      ),
      length
      )
rv_freq_SAR<-rv_freq %>% select(Scientific_Name, Common_Name, Individuals, Records, Set_No) %>% filter (Scientific_Name %in% listed_fish_invert_species$Scientific_Name_upper)

rv_freq2<-aggregate(x=rv_freq[,sapply(rv_freq,is.numeric)],
                   by=c(rv_freq["Scientific_Name"], rv_freq["Common_Name"]),
                    sum)
rv_freq_table<-select(rv_freq2, Scientific_Name, Common_Name, Individuals, Records)
rv_freq_table<-arrange(rv_freq_table, Scientific_Name)
rv_freq_SAR2<-aggregate(x=rv_freq_SAR[,sapply(rv_freq_SAR,is.numeric)],
                   by=c(rv_freq_SAR["Scientific_Name"], rv_freq_SAR["Common_Name"]),
                    sum)

rv_freq_SAR2<-arrange(rv_freq_SAR2, Scientific_Name)

#Table with scientific name, common name, individual counts and number of records
Total_number_records_RV <- sum(rv_freq[[4]])
Total_number_individuals_RV <- sum(rv_freq[[3]])
Total_number_sets_RV<-length(unique(rv_freq$Set_No))
Total_number_SAR_records_RV <- sum(rv_freq_SAR2[[4]])
Total_number_SAR_individuals_RV <- sum(rv_freq_SAR2[[3]])
Total_number_SAR_sets_RV<-length(unique(rv_freq_SAR$Set_No))

RV_summarytable<-data.frame(matrix(ncol = 3, nrow = 2)) 
colnames(RV_summarytable)<-c("Total Individuals", "Total Records", "Total Sets")
rownames(RV_summarytable)<-c("Species at Risk", "All Species")

RV_summarytable[2,2]<-Total_number_records_RV
RV_summarytable[2,1]<-Total_number_individuals_RV
RV_summarytable[2,3]<-Total_number_sets_RV
RV_summarytable[1,2]<-Total_number_SAR_records_RV
RV_summarytable[1,1]<-Total_number_SAR_individuals_RV
RV_summarytable[1,3]<-Total_number_SAR_sets_RV
```

```{r}
Report_RV<-if(x < 1){
    "There are no relevant records in the Maritimes Research Vessel (RV) Survey for this search area."
  } else {
    "There are relevant records in the Maritimes Research Vessel (RV) Survey for this search area."
}
```

```{r}
kable(as.data.frame(RV_summarytable, position = "left"))  %>%
kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
#Develop final RV SAR table
rv_SAR_table<-as.data.frame(rv_freq_SAR2)
rv_SAR_table<-rv_SAR_table %>% rename(Scientific_Name_upper=Scientific_Name)
rv_SAR_table<-mutate(rv_SAR_table, Catch_Frequency=format(round((Records/Total_number_SAR_sets_RV)*100,1), nsmall=1))
rv_SAR_table<-merge(rv_SAR_table, listed_fish_invert_species, by='Scientific_Name_upper')
rv_SAR_table<-select(rv_SAR_table, Scientific_Name, Common_Name.y, Individuals, Records, Catch_Frequency,
                             COSEWIC.status, Schedule.status,Wild_Species)
colnames(rv_SAR_table)<-c("Scientific Name", "Common Name", "No. of Individuals", "Catch Events", 
                          "Catch Frequency", "COSEWIC listing", "SARA status", "Wild Species")

```

```{r}
kable(rv_SAR_table, align="l", caption="Quality Tier: High. Security level: none. Maritimes Research Vessel (RV) Survey observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r}
#Convert geometry to latitude and longitude
RVCatch <- RVCatch %>% extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE)
rv_start_sites<-data.frame(unique(cbind(longitude=RVCatch$lon, latitude=RVCatch$lat)))
rv_end_sites<-data.frame(unique(cbind(longitude=RVCatch$ELONG, latitude=RVCatch$ELAT)))
startx <- rv_start_sites$longitude
starty <- rv_start_sites$latitude
endx <- rv_end_sites$longitude
endy <- rv_end_sites$latitude
```

```{r Fig 2 Ecosystem RV Survey records with polygon, fig.height=8, fig.width=11, fig.cap= "Quality Tier: High. Security level: none. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query information from the Maritimes Research Vessel (RV) Survey. Black lines and arrows indicate the location and direction of each bottom otter trawl sample."}
site_map_new(PEZ_poly,PEZ_poly_st,site_sf,land_sf,2)+
  geom_point(data = rv_start_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, colour = "darkgreen")+
  geom_point(data = rv_end_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, colour = "firebrick4")+
  geom_segment(aes(x = startx, y = starty, xend = endx, yend = endy),arrow=arrow(), size = 1.25)
```

#### **Area-specific MARFIS & ISDB search results**
```{r, include=FALSE, cache=FALSE}
##skip all of these steps and create an isdb file for all of the MAR region.
#df_to_shp(df= isdb, file = "isdb_shp", lat.field = "LATITUDE",lon.field = "LONGITUDE")
#isdb_shp <- st_read("../../../Data/outputs/FarmersLedge4748m/isdb_20190927_1201.shp", quiet=TRUE)
#ISDBCatch <-  SelectISDB_fn(AquaSiteName, PEZversion, minYear)
wd <- getwd() # store main project directory
  data.dir = "../../../Data/mar.wrangling"  # location of ISDB datafiles
  dsn <- "../../../Data/Zones/SearchPEZpolygons"

  # Import the ISDB tables
  get_data('isdb', data.dir=data.dir)
  
  #ISSETPROFILE_WIDE corrections 
  set2<-ISSETPROFILE_WIDE %>%
    mutate(DATE_TIME1 = na_if(DATE_TIME1, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME2 = na_if(DATE_TIME2, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME3 = na_if(DATE_TIME3, "9999-01-01 AST"))
  set2<-set2 %>%
    mutate(DATE_TIME4 = na_if(DATE_TIME4, "9999-01-01 AST"))
  set2$DATE_TIME1[is.na(set2$DATE_TIME1)] <- set2$DATE_TIME2[is.na(set2$DATE_TIME1)]         
  set2$DATE_TIME4[is.na(set2$DATE_TIME4)] <- set2$DATE_TIME3[is.na(set2$DATE_TIME4)]         
  
  set2$LAT1[is.na(set2$LAT1)] <- set2$LAT2[is.na(set2$LAT1)]  
  set2$LONG1[is.na(set2$LONG1)] <- set2$LONG2[is.na(set2$LONG1)]
  
  set2$LAT4[is.na(set2$LAT4)] <- set2$LAT3[is.na(set2$LAT4)]  
  set2$LONG4[is.na(set2$LONG4)] <- set2$LONG3[is.na(set2$LONG4)]
  
  set2$YEAR<-str_sub(set2$DATE_TIME1, start=1, end=4)
  set2<- set2 %>% rename(LATITUDE=LAT1)
  set2<- set2 %>% rename(LONGITUDE=LONG1)
  set3 <-  clip_by_poly(df = set2,
                        lat.field = "LATITUDE",
                        lon.field = "LONGITUDE",
                        clip.poly = PEZ_poly)
  ISSETPROFILE_WIDE <- set3[set3$YEAR >= minYear,]
  
  # limit by year
  self_filter(keep_nullsets = FALSE,quiet = TRUE)
  dsn <- "C:/Temp"
  setwd(dsn)
  save_data(db='isdb')  # this creates both a csv and a shp
  # of the clipped data.  Import the shp as an sf object and 
  # pass back to main script as ISDB_INTERSECT

    # read in the newly created ISDB shapefile
  # as an sf object.

  files <- list.files(dsn,".shp")
  isdb_shp <- files[grep("isdb_",files)] # get shapefile name
  isdb_shp <- substr(isdb_shp,1,nchar(isdb_shp)-4) # remove '.shp' extension

  isdb_sf <- st_read(dsn, layer = isdb_shp, quiet=TRUE)
  # remove all files created by save_data() (shapefile and CSV)
  fl <- list.files(dsn,isdb_shp)
  for(i in 1:length(fl)) {
    file.remove(fl[i])
  }  
  setwd(wd) #revert to original working directory

isdb_intersect <- st_intersection(isdb_sf,PEZ_poly_st)
isdb_sites<-data.frame(longitude=isdb_intersect$LONGI, latitude=isdb_intersect$LATIT)
```

```{r, include=FALSE, cache=FALSE}
isdb_freq <- aggregate(
      x = list(Records = isdb_intersect$SCIENTIFIC),
      by = list(Species = isdb_intersect$SCIENTIFIC),
      length)
isdb_freq <- isdb_freq[order(-isdb_freq$Records),]
rownames(isdb_freq) <- c()
isdb_freq_table<- isdb_freq %>% rename(Scientific_Name_upper=Species)
isdb_freq_table<-merge(isdb_freq_table, listed_fish_invert_species, by='Scientific_Name_upper')
isdb_freq_table2<-isdb_freq_table %>% 
  transmute(Scientific_Name, Common_Name, Schedule.status, COSEWIC.status, Wild_Species, Records)
isdb_record_table<- isdb_freq_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                     "Scientific Name"=Scientific_Name,
                                     "Common Name"=Common_Name)
Total_number_records_isdb <- sum(isdb_freq$Records)
isdb_poly_SAR_total<-isdb_freq %>% select(Species, Records) %>% filter (Species %in% listed_fish_invert_species$Scientific_Name_upper)
Total_number_SAR_records_isdb<-sum(isdb_poly_SAR_total$Records)
```

```{r}
isdb_set_summary_table<-data.frame(Total_organisms_recorded_in_polygon="", LISTED_organisms_recorded_in_polygon="")
isdb_set_summary_table[1,1]<-Total_number_records_isdb
isdb_set_summary_table[1,2]<-Total_number_SAR_records_isdb
isdb_set_summary_table<- isdb_set_summary_table %>% rename("Total organisms recorded in polygon"=Total_organisms_recorded_in_polygon,
                                                           "Listed organisms recorded in polygon"=LISTED_organisms_recorded_in_polygon)

```

```{r}
#table with scientific names of species and number of records
isdb_poly_SAR_records<-isdb_intersect %>% select(SCIENTIFIC, COMMON) %>% filter (SCIENTIFIC %in% listed_fish_invert_species$Scientific_Name_upper)
x<-as.numeric(nrow(isdb_poly_SAR_records))
Report_isdb<-if(x < 1){
    "There are no relevant records in the Industry Survey Database (ISDB) for this search area."
  } else {
    "There are relevant records in the Industry Survey Database (ISDB) for this search area."
}
```

```{r}
(kable(isdb_set_summary_table, align="c", caption="Summary of area-specific ISDB search results.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left"))
```

```{r}
kable(isdb_record_table, align="l", caption="Quality Tier: Medium. Security level: Protected B. Industry Survey Database (ISDB) observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
**Note:** A complete list of ISDB observation records of all species within the provided polygon can be found in the Appendix.

```{r, include=FALSE, cache=FALSE}
#source("fn_Search_MARFIS_Data.r")
#marfis_shp <- st_read("../../../Data/outputs/FarmersLedge4748m/marfis_20190927_1202.shp", quiet=TRUE)

#MARFISCatch <-SelectMARFIS_fn(AquaSiteName, PEZversion, minYear)
wd <- getwd() # store main project directory
  data.dir = "../../../Data/mar.wrangling"  # location of MARFIS datafiles
  dsn <- "../../../Data/Zones/SearchPEZpolygons"

  #Import the MARFIS tables
  #This command did not work for me
  #get_data('marfis', data.dir=data.dir)
  #I developed these instead
  filenames <- list.files(data.dir, pattern="MARFIS*", full.names=TRUE)
  lapply(filenames,load,.GlobalEnv)
    # limit data by MinYear and clip to PEZPoly
  db='marfis'
  PRO_SPC_INFO <-  clip_by_poly(df = PRO_SPC_INFO,
                                lat.field = "LATITUDE",
                                lon.field = "LONGITUDE",
                                clip.poly = PEZ_poly)
  # limit by year
  PRO_SPC_INFO <- PRO_SPC_INFO[PRO_SPC_INFO$YEAR >= minYear,]
  self_filter(keep_nullsets = FALSE,quiet = TRUE)
  dsn <- "C:/Temp"
  setwd(dsn)
  save_data(db='marfis')  # this creates both a csv and a shp
  # of the clipped data.  Import the shp as an sf object and 
  # pass back to main script as MARFIS_INTERSECT
    # read in the newly created MARFIS shapefile
  # as an sf object.
  files <- list.files(dsn,".shp")
  marfis_shp <- files[grep("marfis_",files)] # get shapefile name
  marfis_shp <- substr(marfis_shp,1,nchar(marfis_shp)-4) # remove '.shp' extension
  marfis_sf <- st_read(dsn, layer = marfis_shp, quiet=TRUE)
  # remove all files created by save_data() (shapefile and CSV)
  fl <- list.files(dsn,marfis_shp)
  for(i in 1:length(fl)) {
    file.remove(fl[i])
  }  
  setwd(wd)
marfis_intersect <- st_intersection(marfis_sf,PEZ_poly_st)
marfis_sites<-data.frame(longitude=marfis_intersect$LONGITUDE, latitude=marfis_intersect$LATITUDE)
```

```{r, include=FALSE, cache=FALSE}
marfis_freq <- aggregate(
      x = list(Records = marfis_intersect$SPIES_N),
      by = list(Species = marfis_intersect$SPIES_N),
      length)
marfis_freq <- marfis_freq[order(-marfis_freq$Records),]
rownames(marfis_freq) <- c()
marfis_freq_table<- marfis_freq %>% rename(Common_Name_upper=Species)
marfis_freq_table<-merge(marfis_freq_table, listed_fish_invert_species, by='Common_Name_upper')
marfis_freq_table2<-marfis_freq_table %>% 
  transmute(Scientific_Name, Common_Name, Schedule.status, COSEWIC.status, Wild_Species, Records)
marfis_record_table<- marfis_freq_table2 %>% rename("SARA status"=Schedule.status,
                                                    "COSEWIC listing"=COSEWIC.status,
                                                    "Wild Species listing"=Wild_Species,
                                                    "Scientific Name"=Scientific_Name,
                                                    "Common Name"=Common_Name)
Total_number_records_marfis <- sum(marfis_freq$Records)
marfis_poly_SAR_total<-marfis_freq %>% select(Species, Records) %>% filter (Species %in% listed_fish_invert_species$Common_Name_upper)
Total_number_SAR_records_marfis<-sum(marfis_poly_SAR_total$Records)
```

```{r}
marfis_record_summary_table<-data.frame(Total_organisms_recorded_in_polygon="", LISTED_organisms_recorded_in_polygon="")
marfis_record_summary_table[1,1]<-Total_number_records_marfis
marfis_record_summary_table[1,2]<-Total_number_SAR_records_marfis

```

```{r}
#table with scientific names of species and number of records
marfis_poly_SAR_records<-marfis_intersect %>% select(SPIES_N) %>% filter (SPIES_N %in% listed_fish_invert_species$Common_Name_upper)
x<-as.numeric(nrow(marfis_poly_SAR_records))
Report_isdb<-if(x < 1){
    "There are no relevant records in the Maritimes Fishery Information System (MARFIS) for this search area."
  } else {
    "There are relevant records in the Maritimes Fishery Information System (MARFIS) for this search area."
}
```

```{r}
(kable(marfis_record_summary_table, align="c", caption="Summary of area-specific MARFIS search results.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left"))
```

```{r}
kable(marfis_record_table, align="l", caption="Quality Tier: Medium. Security level: Protected B. Maritimes Fishery Information System (MARFIS) observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

**Note:** A complete list of MARFIS observation records of all species within the provided polygon can be found in the Appendix.

```{r Fig MARFIS and ISDB records, fig.height=8, fig.width=11, fig.cap="Quality Tier: Medium. Security level: Protected B. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query aggregated information from Maritimes Fishery Information System (MARFIS) and/or Industry Survey Database (ISDB) observation records shown as black points, for all species. Rule of five was not applied."}
site_map_new(PEZ_poly,PEZ_poly_st,site_sf,land_sf,2)+
  geom_point(data = isdb_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")+
  geom_point(data = marfis_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")
```

#### **OBIS Search Results**
```{r, include=FALSE, cache=FALSE}
#Select columns of interest from OBIS file
obis_edit<-obis %>% 
  transmute(scientificName, decimalLatitude, decimalLongitude, year,individualCount, rightsHolder, institutionID, institutionCode, collectionCode, datasetID)
 
#Separate CWS/ECCC records
#CWS.ECCC.OBIS_records<-filter(obis_edit, institutionCode=="Canadian Wildlife Service-Atlantic, Environment and Climate Change Canada")
#write.csv(CWS.ECCC.OBIS_records, "CWS_ECCC_OBIS_records.csv")

#Delete WSDB and CWS/ECCC records
obis_edit2<-obis_edit %>%
  filter(! institutionCode =="Canadian Wildlife Service-Atlantic, Environment and Climate Change Canada")
obis_edit3<-obis_edit2 %>%
  filter(! collectionCode =="WHALESITINGS")

obis_plot_locations<-st_as_sf(obis_edit3, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)
intersect_obis <- st_intersection(obis_plot_locations,PEZ_poly_st)
x<-as.numeric(nrow(intersect_obis))

#summarize individual counts
#species_sum<-aggregate(intersect_obis$individualCount, by=list(Species=intersect_obis$scientificName), FUN=sum)

#append columns from listed species
intersect_obis<- intersect_obis %>% rename(Scientific_Name=scientificName)

obis_fish_table<-merge(intersect_obis, listed_fish_invert_species, by='Scientific_Name')
x<-as.numeric(nrow(obis_fish_table))
obis_fish_table2<-obis_fish_table %>% 
  select(Common_Name, Scientific_Name, Schedule.status, COSEWIC.status, Wild_Species)
obis_fish_table3<- obis_fish_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                                    "Scientific Name"=Scientific_Name,
                                                    "Common Name"=Common_Name 
                                     )
obis_fish_table3$geometry<-NULL
obis_fish_table4<-unique(obis_fish_table3)
```

```{r, echo=FALSE, results='asis',}
Query_output_obis<-if(x < 1){
  "There are no relevant records in the Ocean Biodiversity Information System (OBIS) for this search area."
} else {
  "There are relevant records in the Ocean Biodiversity Information System (OBIS) for this search area."
}
writeLines(c(Query_output_obis), sep = "\n")
```

```{r echo=FALSE, results='asis', caption="Priority species with observations contained in the OBIS database within the search polygon area."}
OBIS_query_output_table<-if(x < 1){
  ""
} else {
  kable(obis_fish_table4, row.names = F, caption="Quality Tier: Medium. Security level: none. Ocean Biodiversity Information System (OBIS)
observation records of species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild Species. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}

if(x > 1){OBIS_query_output_table}
```
```{r Fig OBIS records for fish and invertebrates in PEZ polygon, fig.height=8, fig.width=11, fig.cap="Quality Tier: Medium. Security level: none. Map showing the search area defined by the user: location of the proposed project/activity is highlighted in yellow (input polygon), surrounded by an exposure zone or user-defined buffer area in blue. Buffer area was used to query information from Ocean Biodiversity Information System (OBIS) observation records, for species contained within the search area and listed by the Species At Risk Act (SARA), or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC) and Wild species. Sightings on land are an indicator that the sighting data have not yet been completely error-checked or that animals were sighted from shore. The absence of a species in this figure should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area."}
if(x > 1){plot_obis(PEZ_poly,PEZ_poly_st,site_sf,land_sf,intersect_obis,2)}
```

#### **iNaturalist fish and invertebrate Search Results**
```{r, include=FALSE, cache=FALSE}
#Select columns of interest from OBIS file
inat_edit<-inat %>% 
  transmute(scientific_name, datetime, latitude, longitude, common_name, url)
inat_plot_locations<-st_as_sf(inat_edit, coords = c("longitude", "latitude"), crs = 4326)
intersect_inat <- st_intersection(inat_plot_locations,PEZ_poly_st)


#summarize individual counts
#species_sum<-aggregate(intersect_obis$individualCount, by=list(Species=intersect_obis$scientificName), FUN=sum)

#append columns from listed species
intersect_inat<- intersect_inat %>% rename(Scientific_Name=scientific_name)
inat_table<-merge(intersect_inat, listed_fish_invert_species, by='Scientific_Name')
x<-as.numeric(nrow(inat_table))
inat_table2<-inat_table %>% 
  select(Common_Name, Scientific_Name, Schedule.status, COSEWIC.status, Wild_Species)
inat_table3<- inat_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                     "Scientific Name"=Scientific_Name,
                                     "Common Name"=Common_Name)
inat_table3$geometry<-NULL
inat_table4<-unique(inat_table3)
```

```{r, echo=FALSE, results='asis'}
Query_output_inat<-if(x < 1){
  "There are no records of priority specues in the iNaturalist database for the provided search area."
} else {
  "The iNaturalist database contains records of priority species in the provided search area."
}

Query_output_inat2<-noquote(Query_output_inat)

writeLines(c(Query_output_inat2), sep = "\n")
```

```{r echo=FALSE, results='asis'}
INAT_query_output_table<-if(x < 1){
  ""
} else {
  kable(inat_table4, row.names = F, caption="Map showing the defined Potential Exposure Zone (PEZ; blue) and proposed project polygon (yellow) with iNaturalist records shown as black points.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}
if(x > 1){INAT_query_output_table}
```

```{r Fig 5 INAT fish and invert records in PEZ polygon, fig.height=8, fig.width=11, fig.cap="Map showing the defined Potential Exposure Zone (PEZ; blue) and proposed project polygon (yellow) with iNaturalist records shown as black points."}
if(x > 1){plot_inat(PEZ_poly,PEZ_poly_st,site_sf,land_sf,inat_table,2)}
```

#### **GBIF fish and invertebrate Search Results**
```{r, include=FALSE, cache=FALSE}
#Select columns of interest from OBIS file
gbif_sf<-st_as_sf(gbif, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)
intersect_gbif <- st_intersection(gbif_sf,PEZ_poly_st)

#summarize individual counts
#species_sum<-aggregate(intersect_obis$individualCount, by=list(Species=intersect_obis$scientificName), FUN=sum)

#append columns from listed species
intersect_gbif<- intersect_gbif %>% rename(Scientific_Name=species)
gbif_table<-merge(intersect_gbif, listed_fish_invert_species, by='Scientific_Name')
x<-as.numeric(nrow(gbif_table))
gbif_table2<-gbif_table %>% 
  select(Common_Name, Scientific_Name, Schedule.status, COSEWIC.status, Wild_Species)
gbif_table3<- gbif_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                     "Scientific Name"=Scientific_Name,
                                     "Common Name"=Common_Name)
gbif_table3$geometry<-NULL
gbif_table4<-unique(gbif_table3)
```

```{r, echo=FALSE, results='asis'}
Query_output_gbif<-if(x < 1){
  "There are no records of species at risk in the GBIF database for the provided search area."
} else {
  "The GBIF database contains records of species at risk in the provided search area."
}
Query_output_gbif2<-noquote(Query_output_gbif)

writeLines(c(Query_output_gbif2), sep = "\n")
```

```{r echo=FALSE, results='asis'}
GBIF_query_output_table<-if(x < 1){
  ""
} else {
  kable(gbif_table4, row.names = F, caption="Map showing the defined search area with GBIF records shown as black points.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}

if(x > 1){GBIF_query_output_table}
```

```{r Fig 5 OBIS records for fish and invert species section in PEZ polygon, fig.height=8, fig.width=11, fig.cap="The tier of confidence of this map is **Medium**. Map represents OBIS records within the search area where other species of Species at Risk (non cetacean, fish or invertebrate species) may have been observed. Absence of a species in the map should be interpreted as an absence of reporting, not as an absence of the species in the area (e.g. sightings information underrepresents presence of cetaceans as this search does not include acoustic detections). Sightings on land are an indicator that the sighting data have not yet been completely error-checked."}
if(x > 1){plot_gbif(PEZ_poly,PEZ_poly_st,site_sf,land_sf,gbif_table,2)}
```

#### **Passamaquoddy Biodiversity fish and invertebrate Search Results**
```{r, include=FALSE, cache=FALSE}
Passamaquoddy_catch<-read.csv("../../../Data/NaturalResources/Species/PassamaquoddyBayBiodiversityTrawl/passamaquoddy_bay_biodiversity_trawl_catch_data.csv")
Passamaquoddy_set<-read.csv("../../../Data/NaturalResources/Species/PassamaquoddyBayBiodiversityTrawl/passamaquoddy_bay_biodiversity_trawl_set_data.csv")
#creating unique combined set and station numbers for set file
Passamaquoddy_setb<-Passamaquoddy_set
Passamaquoddy_setb$setno<-sprintf('%.3f',Passamaquoddy_setb$setno)
Passamaquoddy_setb$y<-str_sub(Passamaquoddy_setb$setno, start=5, end=-1)
Passamaquoddy_setb$setno_comb<-paste(Passamaquoddy_setb$mission, Passamaquoddy_setb$y,".",Passamaquoddy_setb$station)
Passamaquoddy_setb$setno_comb<-str_replace_all(Passamaquoddy_setb$setno_comb, pattern=" ", repl="")
#creating unique combined set and station numbers for catch file
Passamaquoddy_catchb<-Passamaquoddy_catch
Passamaquoddy_catchb$setno<-sprintf('%.3f',Passamaquoddy_catchb$setno)
Passamaquoddy_catchb$y<-str_sub(Passamaquoddy_catchb$setno, start=5, end=-1)
Passamaquoddy_catchb$setno_comb<-paste(Passamaquoddy_catchb$mission, Passamaquoddy_catchb$y,".",Passamaquoddy_catchb$station)
Passamaquoddy_catchb$setno_comb<-str_replace_all(Passamaquoddy_catchb$setno_comb, pattern=" ", repl="")
Passamaquoddy_merged<-merge(Passamaquoddy_catchb, Passamaquoddy_setb, by='setno_comb')
#merge data frames
Passamaquoddy_merged<-select(Passamaquoddy_merged, setno_comb, longitude_start, latitude_start, longitude_finish, latitude_finish,
                             time_start, time_finish, scientific_name, common_name, abundance)
#modify date to year, month and day columns
Passamaquoddy_merged$year=Passamaquoddy_merged$time_start
Passamaquoddy_merged$year<-str_sub(Passamaquoddy_merged$year, start=1, end=4)
Passamaquoddy_merged$month=Passamaquoddy_merged$time_start
Passamaquoddy_merged$month<-str_sub(Passamaquoddy_merged$month, start=6, end=7)
Passamaquoddy_merged$day=Passamaquoddy_merged$time_start
Passamaquoddy_merged$day<-str_sub(Passamaquoddy_merged$day, start=9, end=10)
```

```{r, include=FALSE, cache=FALSE}
#Select columns of interest from OBIS file
quoddy<-subset(Passamaquoddy_merged,year>minYear,year<maxYear)
quoddy_sf<-st_as_sf(quoddy, coords = c("longitude_start", "latitude_start"), crs = 4326)
intersect_quoddy <- st_intersection(quoddy_sf,PEZ_poly_st)

#summarize individual counts
#species_sum<-aggregate(intersect_obis$individualCount, by=list(Species=intersect_obis$scientificName), FUN=sum)

#append columns from listed species
intersect_quoddy<- intersect_quoddy %>% rename(Scientific_Name=scientific_name)
quoddy_table<-merge(intersect_quoddy, listed_fish_invert_species, by='Scientific_Name')
x<-as.numeric(nrow(quoddy_table))
quoddy_table2<-quoddy_table %>% 
  select(Common_Name, Scientific_Name, Schedule.status, COSEWIC.status, Wild_Species)
quoddy_table3<- quoddy_table2 %>% rename("SARA status"=Schedule.status,
                                     "COSEWIC listing"=COSEWIC.status,
                                     "Wild Species listing"=Wild_Species,
                                                    "Scientific Name"=Scientific_Name,
                                                    "Common Name"=Common_Name)
quoddy_table3$geometry<-NULL
quoddy_table4<-unique(quoddy_table3)
```

```{r, echo=FALSE, results='asis'}
Query_output_quoddy<-if(x < 1){
  "There are no records of species at risk in the Passamaquoddy Bay biodiversity trawl data for the provided search area."
} else {
  "The Passamaquoddy Bay biodiversity trawl data contains records of species at risk in the provided search area."
}

Query_output_quoddy2<-noquote(Query_output_quoddy)

writeLines(c(Query_output_quoddy2), sep = "\n")
```

```{r echo=FALSE, results='asis'}
quoddy_query_output_table<-if(x < 1){
  ""
} else {
  kable(quoddy_table4, row.names = F, caption="Map showing the defined search area with Passamaquoddy Bay biodiversity trawl data shown as black points.") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}

if(x > 1){quoddy_query_output_table}
```

```{r Fig 5 Passamaquoddy fish and invert species section in PEZ polygon, fig.height=8, fig.width=11, fig.cap="The tier of confidence of this map is **Medium**. Map represents OBIS records within the search area where other species of Species at Risk (non cetacean, fish or invertebrate species) may have been observed. Absence of a species in the map should be interpreted as an absence of reporting, not as an absence of the species in the area (e.g. sightings information underrepresents presence of cetaceans as this search does not include acoustic detections). Sightings on land are an indicator that the sighting data have not yet been completely error-checked."}
if(x > 1){plot_gbif(PEZ_poly,PEZ_poly_st,site_sf,land_sf,gbif_table,2)}
```