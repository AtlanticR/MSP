---
title: "Reproducible Report for Species in Maritimes Region - for Internal DFO use only"
author: Synthesis prepared by the Reproducible Reporting Team, steering committee and advisors.
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    theme: paper
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---
```{r Clean up environment for new report, echo=FALSE, include=FALSE, cache=FALSE}
rm(list=ls(all=TRUE))
```
```{r setup, echo=FALSE, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
library(Mar.datawrangling)
library(Mar.utils)
library(knitr)
library(kableExtra)
library(rgdal)
library(maps)
library(lubridate)
library(raster)
library(RCurl)
library(sf)
library(stringr)
library(ggplot2)
library(data.table)
library(gridExtra)
library(dplyr)
library(stars)
library(ggspatial)
#install.packages("remotes")
#remotes::install_github("terminological/standard-print-output")
#library(standardPrintOutput)
#These next two lines are necessary for the generation of the water mark on all plots.
#install.packages("devtools")
#devtools::install_github("JosephCrispell/basicPlotteR")
library(basicPlotteR)
```
```{r source functions, echo=FALSE, include=FALSE, cache=FALSE}
# the .Rmd file sets the working directory based on where it resides and ignores the wd set by the .RProj file
source("site_map.r")
source("site_map_new.r")
source("plot_wsdb.r")
source("filter_wsdb.r")
source("plot_narwc.r")
source("plot_narwc.r")
source("filter_narwc_new.r")
# ## Another option is to load directly from the web and read in using Rcurl
#function_urls <- c("https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/site_map.r",
#                    "https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/plot_wsdb.r",
#                    "https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/filter_wsdb.r")
#for (i in function_urls){eval(parse(text = RCurl::getURL(i, ssl.verifypeer = FALSE)),envir=.GlobalEnv)}
source("EBSA.R")
source("plot_EBSA.R")
source("leatherback.R")
source("plot_leatherback.R")
source("plot_obis.R")
source("plot_cws.R")
source("plot_crithab.R")
source("plot_crithab_zoom.R")
source("plot_inat.R")
source("cetacean_priority_areas.R")
source("plot_cetaceans_4grid.R")
source("Blue_Whale_habitat.R")
source("plot_bw_hab.R")
source("plot_bw_hab_zoom.R")
```

```{r Define Site, echo=FALSE, include=FALSE, cache=FALSE}
#HTML output of code is automatically generated in Catalina's computer: RProjects/MSP/SearchPEZ/code
#output of get.data.R should be manually moved to RProjects/MSP/SearchPEZ/outputs/sitenamexkm  
#AquaSiteName <- "TestGully"
#PEZversion <- "Polygon"
AquaSiteName <- "FarmersLedge"
PEZversion <- "4748m"
UserComments <- "Example - First search effort for suitability of a site for a project planned for 2025. Project is expected to have positive/negative impacts on surrounding area. It is likely that some kind of monitoring will be required during operations. Make sure to follow up on all sections pertaining to a particular taxonomic group as this seems to be a concern of the stakeholders."
#make sure you delete all shp.xml files in the folder to be able to run this code
minYear <- 1970
maxYear <- 2020
```

# **Introduction**

### **About this report**

This reproducible report summarizes species that have been reported in specific areas drawing from databases available, both within and outside the Department. This report provides a general list of priority species (listed by SARA, COSEWIC and Wild Species) that have been reported in a given user defined area. This report is for internal DFO use only. No maps, layers, or data that violate the rule of 5 will be shared outside of the department. 

**Species listings reported in this section:**

*SARA* - The Species at Risk Act (SARA) was proclaimed in June 2003, and is one part of a three part Government of Canada strategy for the protection of wildlife species at risk. This three part strategy also includes commitments under the Accord for the Protection of Species at Risk and activities under the Habitat Stewardship Program for Species at Risk. The purposes of SARA are to prevent Canadian indigenous species, subspecies, and distinct populations from becoming extirpated or extinct, to provide for the recovery of endangered or threatened species, and encourage the management of other species to prevent them from becoming at risk. It applies to all federal lands in Canada; all wildlife species listed as being at risk; and their critical habitat.
For more information on SARA visit <https://www.canada.ca/en/environment-climate-change/services/species-risk-public-registry.html> 

*COSEWIC* - The Committee on the Status of Endangered Wildlife in Canada (COSEWIC) is an independent advisory panel to the Minister of Environment and Climate Change Canada that meets twice a year to assess the status of wildlife species at risk of extinction. Members are wildlife biology experts from academia, government, non-governmental organizations and the private sector responsible for designating wildlife species in danger of disappearing from Canada. COSEWIC determines the national status of wild Canadian species, subspecies, varieties or other designatable units that are suspected of being at risk of extinction or extirpation. COSEWIC uses a process based on science and Aboriginal or community knowledge to assess wildlife species at risk. All native mammals, birds, reptiles, amphibians, fish, arthropods, molluscs, vascular plants, mosses and lichens are included in COSEWIC's current mandate.
For more information on COSEWIC visit <https://www.cosewic.ca/index.php/en-ca/>

*Wild species* - Every five years the National General Status Working Group (NGSWG), which includes representatives from all provincial and territorial governments in Canada, and from the federal government, publishes a general report on the status of wildlife species in Canada. These reports are meant to inform Canadians about the status of species in the country, and to help prevent species in Canada from becoming extinct as a consequence of human activity.
For more information about Wild Species reports visit <https://www.wildspecies.ca/home>

### **How to use this report**

Absence of a species in this report should be interpreted as an absence of reporting, not as an absence of the species in the area. The focus of this report is on species presence and not on associated numbers, frequency, or catch information.The aquaculture Science group led by Fred Page works with the Aquaculture site information, including current meter data, to calculate the Potential Exposure Zones (PEZ) of the aquaculture inputs (depositional feed/feces, advective/dispersive fish health treatments, etc.). This PEZ polygon is then used in this document to search regional databases (2002 - 2018) and summarize species that have been recorded. This information is used to determine if other, more site-specific, information is available on species presence for PEZ as a complement to the information provided by the proponent. Species lists generated in this synthesis is subsequently circulated to units in Maritimes Science to verify and compliment the information provided (e.g. spatial and temporal presence/absence of species in the area). 

### **Intent of this report**

The intent of this report for all users is to prompt a circulation of the species list generated in this synthesis to appropriate DFO units and sectors to verify and supplement the information provided (e.g. reported spatial and temporal presence/absence of species in the area).

### **Resources and Sources of Uncertainty**

Coastal and offshore areas of the Scotian Shelf bioregion are generally not adequately sampled, and hence information on these space and time scales is generally not contained within the various data sources available to DFO, including the surveys referred to in this document. Therefore, there is uncertainty as to the exact distribution of species in the search.

### **Tiers of confidence in data sources**

There are various data sources featured in this report, including federal and provincial agencies, non-proft organizations and citizen groups. Below is a framework by which users can assess the confidence with which they can assess the different data sources provided throughout the report.
```{r echo=FALSE, results='asis'}
Tier_table<-matrix(c("Records available from systematic surveys, with qualified observers/personnel.", "This record has high certainty, and it comes from a reliable source (not necessarily DFO).", "RV survey, NARWC", "Records available from a mix of opportunistic and systematic surveys, quality control has been applied, although additional work is required to verify information.", "This record has medium certainty, and it comes from a reliable source. Use with caution.", "ISDB, MARFIS", "Primarily opportunistic surveys, or results of invalidated models. Data quality protocols still required, quality control not standardized or explored just yet in this report.", "Use with caution. Use at your own discretion, preferably only if data in high/medium tiers validates information from this tier. Very high uncertainty. ", "WSDB, Priority area for cetaceans"), ncol=3,byrow=TRUE)
colnames(Tier_table)<-c("Description", "Usage recommendations", "Examples")
rownames(Tier_table)<-c("High Confidence", "Medium Confidence", "Low Confidence")
Tiers<-as.table(Tier_table)
```
```{r}
kable(Tiers, align="l") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

# **Search area**

**Site: **
```{r echo=FALSE, results='asis'}
cat(AquaSiteName)
```

**Potential Exposure Zone (PEZ) radius: **
```{r echo=FALSE, results='asis'}
cat(PEZversion)
```

**PEZ features/comments from user: **
```{r echo=FALSE, results='asis'}
cat(UserComments)
```

```{r Set up paths, echo=FALSE, include=FALSE, cache=FALSE}
mspPath <- "../"
data.dir = "../../../Data/mar.wrangling"
#create a folder in outputs with the name of the site and buffer area search
dataPath <- file.path("../../../Data/outputs",paste0(AquaSiteName,PEZversion))
# setwd(dataPath) #not needed?
polyPath <- "../../../Data/Zones/SearchPEZpolygons"
site <- readOGR(polyPath,layer=paste0("Site_",AquaSiteName))
site_sf <- st_as_sf(site)
opendataPath = "../../../Data/mar.wrangling/RVSurvey_OpenData"
#wsdbFile <- file.path("../inputs","WSDB_GLazin_AllSpecies_2018.csv")
wsdbFile <- file.path("../../../Data/NaturalResources/Species/Cetaceans/WSDB","MarWSDBSightingsForCGomez_27Oct2020.csv")
narwcFile <- file.path("../../../Data/NaturalResources/Species/Cetaceans/NARWC","NARWC_09-18-2020.csv")
```
```{r read baseline data for maps, echo=FALSE, include=FALSE, cache=FALSE}
landGDB <- "../../../Data/Boundaries/Coast50K/Coastline50k.gdb"
land <- readOGR(dsn=landGDB,layer="Land50k_Maritimes",stringsAsFactors=F)
land_sf <- st_as_sf(land)
```
```{r Define PEZ!, echo=FALSE, include=FALSE, cache=FALSE}
pl <- list.files(polyPath,"*.shp")
pl <- pl[-grep("xml",pl)]
PEZ_poly <- readOGR(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]))
#PEZ_poly_st<-st_read(../../../Data/Zones/SearchPEZpolygons/PEZ_TestGullyPolygon.shp", quiet=TRUE)
PEZ_poly_st<-st_as_sf(PEZ_poly)
```
```{r Species listed by Wildspecies, COSEWIC and SARA in the Maritime Region, echo=FALSE, include=FALSE, cache=FALSE}

listed_species<-read.csv("../../../Data/NaturalResources/Species/MAR_listed_species.csv")
MARSAR_com <- listed_species$Common_Name
MARSAR_com_up <- listed_species$Common_Name_upper
MARSAR_sci <- listed_species$Scientific_Name
MARSAR_sci_up <- listed_species$Scientific_Name_upper
```

```{r Fig 1 PEZ polygon, fig.height=8, fig.width=11}
site_map_new(PEZ_poly,PEZ_poly_st,site_sf,land_sf,40)
```
**Fig. 1:** Map showing the defined Potential Exposure Zone (PEZ) polygon (blue) used to search regional databases and summarize recorded species.
