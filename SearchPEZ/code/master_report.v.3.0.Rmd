---
title: "Reproducible Report for Species in Maritimes Region - for Internal DFO use only"
author: Synthesis prepared by the MSP Team
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    theme: paper
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r Define Site, echo=FALSE, include=FALSE, cache=FALSE}
#HTML output of code is automatically generated in Catalina's computer: RProjects/MSP/SearchPEZ/code
#output of get.data.R should be manually moved to RProjects/MSP/SearchPEZ/outputs/sitenamexkm  
rm(list=ls(all=TRUE))
#AquaSiteName <- "TestGully"
#PEZversion <- "Polygon"
AquaSiteName <- "FarmersLedge"
PEZversion <- "4748m"
#make sure you delete all shp.xml files in the folder to be able to run this code
minYear <- 2002
cat(AquaSiteName)
```
```{r setup, echo=FALSE, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
library(Mar.datawrangling)
library(Mar.utils)
library(knitr)
library(kableExtra)
library(rgdal)
library(maps)
library(lubridate)
library(raster)
library(RCurl)
library(sf)
library(stringr)
library(ggplot2)
library(data.table)
library(gridExtra)
library(dplyr)
library(stars)
library(ggspatial)
###These next two lines are necessary for the generation of the water mark on all plots.#######
#install.packages("devtools")
#devtools::install_github("JosephCrispell/basicPlotteR")
library(basicPlotteR)
#source("C:/RProjects/SearchPEZ/code/.Rprofile") #Catalina's path to access Oracle passwords
```
```{r source functions, echo=FALSE, include=FALSE, cache=FALSE}
# the .Rmd file sets the working directory based on where it resides and ignores the wd set by the .RProj file
source("site_map.r")
source("site_map_old.r")
source("plot_wsdb.r")
source("filter_wsdb.r")
source("plot_narwc.r")
source("filter_narwc.r")
# ## Another option is to load directly from the web and read in using Rcurl
# function_urls <- c("https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/site_map.r",
#                    "https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/plot_wsdb.r",
#                    "https://raw.githubusercontent.com/AtlanticR/MSP/master/SearchPEZ/code/filter_wsdb.r")
# 
# for (i in function_urls){eval(parse(text = RCurl::getURL(i, ssl.verifypeer = FALSE)),envir=.GlobalEnv)}
```

```{r Set up paths, echo=FALSE, include=FALSE, cache=FALSE}
mspPath <- "../"
data.dir = "../../../Data/mar.wrangling"
#create a folder in outputs with the name of the site and buffer area search
dataPath <- file.path("../../../Data/outputs",paste0(AquaSiteName,PEZversion))
# setwd(dataPath) #not needed?
polyPath <- "../../../Data/Zones/SearchPEZpolygons"
site <- readOGR(polyPath,layer=paste0("Site_",AquaSiteName))
site_sf <- st_as_sf(site)
opendataPath = "../../../Data/mar.wrangling/RVSurvey_OpenData"
#wsdbFile <- file.path("../inputs","WSDB_GLazin_AllSpecies_2018.csv")
wsdbFile <- file.path("../../../Data/NaturalResources/Species/Cetaceans/WSDB","MarWSDBSightingsForCGomez_27Oct2020.csv")
narwcFile <- file.path("../../../Data/NaturalResources/Species/Cetaceans/NARWC","NARWC_09-18-2020.csv")
```

```{r read baseline data for maps, echo=FALSE, include=FALSE, cache=FALSE}
landGDB <- "../../../Data/Boundaries/Coast50K/Coastline50k.gdb"
land <- readOGR(dsn=landGDB,layer="Land50k_Maritimes",stringsAsFactors=F)
land_sf <- st_as_sf(land)
```

```{r Define PEZ!, echo=FALSE, include=FALSE, cache=FALSE}
pl <- list.files(polyPath,"*.shp")
pl <- pl[-grep("xml",pl)]
PEZ_poly <- readOGR(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]))
#PEZ_poly_st<-st_read(../../../Data/Zones/SearchPEZpolygons/PEZ_TestGullyPolygon.shp", quiet=TRUE)
PEZ_poly_st<-st_as_sf(PEZ_poly)
```

```{r Species listed by Wildspecies, COSEWIC and SARA in the Maritime Region, echo=FALSE, include=FALSE, cache=FALSE}

listed_species<-read.csv("../../../Data/NaturalResources/Species/SAR_MAR_Region_SORTED.csv")
MARSAR_com <- listed_species$Common_Name
MARSAR_com_up <- listed_species$Common_Name_upper
MARSAR_sci <- listed_species$Scientific_Name
MARSAR_sci_up <- listed_species$Scientific_Name_upper
```

### **About this report**

This reproducible report summarizes species that have been reported in specific areas drawing from databases available, both within and outside the Department (**2002 - 2018**). This report is for internal DFO use only. No maps, layers, or data that violate the rule of 5 will be shared outside of the department. 

### **How to use this report**

This report provides a general list of species that have been reported in a given area. Absence of a species in this report should be interpreted as an absence of reporting, not as an absence of the species in the area. The focus of this report is on species presence and not on associated numbers, frequency, or catch information. For more information, please read the "resources and sources of uncertainty" section of this document. 

The intent of this report for all users is to prompt a circulation of the species list generated in this synthesis to appropriate DFO units and sectors to verify and supplement the information provided (e.g. reported spatial and temporal presence/absence of species in the area).

### **Tiers of confidence** in data sources.

There are various data sources featured in this report, including federal and provincial agencies, non-proft organizations and citizen groups. Below is a framework by which users can assess the confidence with which they can assess the different data sources provided throughout the report.

```{r echo=FALSE, results='asis'}
Tier_table<-matrix(c("Records available from systematic surveys, with qualified observers/personnel.", "This record has high certainty, and it comes from a reliable source (not necessarily DFO).", "RV survey, NARWC", "Records available from a mix of opportunistic and systematic surveys, quality control has been applied, although additional work is required to verify information.", "Use with caution.", "TBA", "Primarily opportunistic surveys, or results of invalidated models. Data quality protocols still required, quality control not standardized or explored just yet in this report.", "Use with caution. Use at your own discretion, preferably only if data in high/medium tiers validates information from this tier. Very high uncertainty. ", "WSDB, Priority area for cetaceans"), ncol=3,byrow=TRUE)
colnames(Tier_table)<-c("Description", "Usage recommendations", "Examples")
rownames(Tier_table)<-c("High Confidence", "Medium Confidence", "Low Confidence")
Tiers<-as.table(Tier_table)
```

```{r}
kable(Tiers, align="l") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

### **Search area**

Map below shows the polygon (blue) used to search regional databases and summarize species reported.

**Site:**
```{r echo=FALSE, results='asis'}
cat(AquaSiteName)
```

```{r Fig 1 PEZ polygon, fig.height=8, fig.width=11}
site_map(PEZ_poly,PEZ_poly_st,site_sf,land_sf,40)

```

# **Databases**

```{r read csv extracted with previous chunck, echo=FALSE, include=FALSE, cache=FALSE}
fl <- list.files(dataPath,".csv")
marfis <- read.csv(file.path(dataPath,fl[grep("marfis_",fl)]))
marfis <- marfis[which(year(marfis$DATE_FISHED)>=minYear),]
isdb <- read.csv(file.path(dataPath,fl[grep("isdb_",fl)]))
isdb <- isdb[which(year(isdb$DATE_TIME2)>=minYear),]
rv <- read.csv(file.path(dataPath,fl[grep("rv_",fl)]))
rv <- rv[which(year(rv$SDATE)>=minYear),]
#Load RV Open Data summary file prepared using RVSurvey_OpenData_summary.R script.
rv_OD <- read.csv(file.path(opendataPath,("rv_OD_summary.csv")))
rv_OD <- rv[which(year(rv$SDATE)>=minYear),]
#Word from Remi Daigle is that this data set is not ready yet.
obis<-read.csv("../../../Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/OBIS_CBIF_iNaturalist.csv")
#obis <- obis[which(year(obis$year)>=minYear),]
```

### **Industry Survey Database (ISDB)**

ISDB is a DFO database that contains at-sea fish catch observations from commercial fishing vessels operating in the North West Atlantic. The data provided by ISDB is confidential and cannot be communicated outside of the DFO, given teh direct implications of the Rule of 5.

```{r, echo=FALSE, include=FALSE, cache=FALSE}
##skip all of these steps and create an isdb file for all of the MAR region.
#df_to_shp(df= isdb, file = "isdb_shp", lat.field = "LATITUDE",lon.field = "LONGITUDE")
isdb_shp <- st_read("../../../Data/outputs/FarmersLedge4748m/isdb_20190927_1201.shp", quiet=TRUE)
isdb_intersect <- st_intersection(isdb_shp,PEZ_poly_st)
isdb_sites<-data.frame(longitude=isdb_intersect$LONGITUDE, latitude=isdb_intersect$LATITUDE)
```

```{r, echo=FALSE, include=FALSE, cache=FALSE}
isdb_freq <- aggregate(
      x = list(Records = isdb_intersect$SCIENTIFI1),
      by = list(Species = isdb_intersect$SCIENTIFI1
      ),
      length
      )
isdb_freq <- isdb_freq[order(-isdb_freq$Records),]
rownames(isdb_freq) <- c()
Total_number_records_isdb <- sum(isdb_freq$Records)
isdb_poly_SAR_total<-isdb_freq %>% select(Species, Records) %>% filter (Species %in% MARSAR_sci_up)
Total_number_SAR_records_isdb<-sum(isdb_poly_SAR_total$Records)
```

```{r}
#table with scientific names of species and number of records
isdb_poly_SAR_records<-isdb_intersect %>% select(SCIENTIFI1, COMMON) %>% filter (SCIENTIFI1 %in% MARSAR_sci_up)

x<-as.numeric(nrow(isdb_poly_SAR_records))

Report_isdb<-if(x < 1){
    "There are no records of Species at Risk in the Industry Survey Database (ISDB) for this polygon."
  } else {
    
CommonName<-isdb_intersect$COMMON
Species<-isdb_intersect$SCIENTIFI1

#list of SAR species in polygon
isdb_poly_SAR_list<-unique(isdb_poly_SAR_records$SCIENTIFI1)


#build table with rows containing sets in which SARs were captured 
isdb_setcounttable<-data.frame(Common_Name="", Scientific_Name_upper="", SARA_listing="", COSEWIC_listing="", Wild_Species_listing="", Set_Occurence=0, Set_Frequency=0)

isdb_poly_filter_sets<-isdb_intersect %>% filter(SCIENTIFI1 %in% isdb_poly_SAR_list)

#scientific names column
for(i in 1:length(isdb_poly_SAR_list)){
  isdb_spec<-isdb_intersect %>% filter(SCIENTIFI1 %in% isdb_poly_SAR_list[i])
  set_count<-length(unique(isdb_spec$SET_NO))
  isdb_setcounttable[i,2]<-isdb_poly_SAR_list[i]
  isdb_setcounttable[i,6]<-set_count
}

#common names column
isdb_poly_SAR_list_com<-unique(isdb_poly_SAR_records$COMMON)
for(i in 1:length(isdb_poly_SAR_list)){
  isdb_com<-isdb_intersect %>% filter(COMMON %in% isdb_poly_SAR_list_com[i])
  set_count<-length(unique(isdb_com$SET_NO))
  isdb_setcounttable[i,1]<-isdb_poly_SAR_list_com[i]
  isdb_setcounttable[i,6]<-set_count
}

isdb_setcounttabledf<-as.data.frame(isdb_setcounttable)

#Count sets
Total_sets<-length(unique(isdb_intersect$SET_NO))

}
```

```{r}
isdb_set_summary_table<-data.frame(Sets_recorded_in_polygon="", Organisms_recorded_in_polygon="", Listed_organisms_recorded_in_polygon="")
isdb_set_summary_table[1,1]<-Total_sets
isdb_set_summary_table[1,2]<-Total_number_records_isdb
isdb_set_summary_table[1,3]<-Total_number_SAR_records_isdb

```

```{r}
kable(isdb_set_summary_table, align="c") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
isdb_setcounttable2<-mutate(isdb_setcounttabledf, Set_Frequency=format(round((Set_Occurence/Total_sets)*100,1), nsmall=1))
isdb_table<-merge(isdb_setcounttable2, listed_species, by='Scientific_Name_upper')
isdb_table2<-isdb_table %>% 
  transmute(Scientific_Name, Common_Name.y, Schedule.status, COSEWIC.status, Wild_Species, Set_Occurence,Set_Frequency)
isdb_table3<- isdb_table2 %>% rename(Common_Name=Common_Name.y,
                                     SARA_listing=Schedule.status,
                                     COSEWIC_listing=COSEWIC.status,
                                     Wild_Species_listing=Wild_Species,
                                     Set_occurence=Set_Occurence,
                                     Set_frequency=Set_Frequency
                                     )

```

 **Table 1:** ISDB records of species observed within the provided polygon which have a listed status wotj SARA, COSEWIC or Wild Species. Data is summarized by species or species group.

```{r}
kable(isdb_table3, align="l") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
**Note:** A complete list of ISDB observation records of all species within the provided polygon can be found in the Appendix.

### **The Maritime Fishery Information System (MARFIS)**

MARFIS is a DFO database, managed by the Policy & Economics Branch. MARFIS contains: catch and effort, quota, and licensing information for the Maritimes region. The catch and effort data contains the log information for all commercial fisheries that land within this region. If a Maritimes region commercial vessel lands in another DFO region or outside of Canadian waters, it is not included in the database. The majority of catch information is related to commercial offloads. There is also more limited data related to discards and the SARA log. Not all catch records have associated lat/long coordinates. This may be due to the structure of the log itself, or missing data. Generally all records have a NAFO Division and NAFO Unit Area flag, even if no coordinates have been provided. Data for the years 2017-2020 is preliminary and subject to change without notice. There may be some limited changes to data in the years 2016 and previous. Ongoing qa/qc work is done on the MARFIS database, but not all errors are corrected. If you have data errors, questions, or corrections, you can send them to our data quality inbox: CDDDataQuality@dfo-mpo.gc.ca. Requests for data exports can be sent to: XMARComData@dfo-mpo.gc.ca. This information about MARFIS was provided by Colin.O'Neil@dfo-mpo.gc.ca (July 2020, Policy & Economics Branch).

```{r, echo=FALSE, include=FALSE, cache=FALSE}
##skip all of these steps and create an isdb file for all of the MAR region.
#df_to_shp(df= isdb, file = "isdb_shp", lat.field = "LATITUDE",lon.field = "LONGITUDE")
marfis_shp <- st_read("../../../Data/outputs/FarmersLedge4748m/marfis_20190927_1202.shp", quiet=TRUE)
marfis_intersect <- st_intersection(marfis_shp,PEZ_poly_st)
marfis_sites<-data.frame(longitude=marfis_intersect$LONGITUDE, latitude=marfis_intersect$LATITUDE)
```

```{r, echo=FALSE, include=FALSE, cache=FALSE}
marfis_freq <- aggregate(
      x = list(Records = marfis_intersect$SPECIENAME),
      by = list(Species = marfis_intersect$SPECIENAME),
      length)
marfis_freq <- marfis_freq[order(-marfis_freq$Records),]
rownames(marfis_freq) <- c()
Total_number_records_marfis <- sum(marfis_freq$Records)
marfis_poly_SAR_total<-marfis_freq %>% select(Species, Records) %>% filter (Species %in% MARSAR_com_up)
Total_number_SAR_records_marfis<-sum(marfis_poly_SAR_total$Records)
```

```{r}
#table with scientific names of species and number of records
marfis_poly_SAR_records<-marfis_intersect %>% select(SPECIENAME) %>% filter (SPECIENAME %in% MARSAR_com_up)

x<-as.numeric(nrow(marfis_poly_SAR_records))

Report_marfis<-if(x < 1){
    "There are no records of Species at Risk in the Industry Survey Database (ISDB) for this polygon."
  } else {
    
CommonName<-marfis_intersect$SPECIENAME

#list of SAR species in polygon
marfis_poly_SAR_list<-unique(marfis_poly_SAR_records$SPECIENAME)


#build table with rows containing sets in which SARs were captured 
marfis_setcounttable<-data.frame(Common_Name="", Scientific_Name_upper="", SARA_listing="", COSEWIC_listing="", Wild_Species_listing="", Set_Occurence=0, Set_Frequency=0)
marfis_poly_filter_sets<-marfis_intersect %>% filter(SPECIENAME %in% marfis_poly_SAR_list)
marfis_poly_filter_sets<- marfis_poly_filter_sets %>% rename(Common_Name_upper=SPECIENAME)
marfis_poly_filter_sets$Common_Name_upper
listed_species$Common_Name_upper
marfis_SAR_master<-merge(marfis_poly_filter_sets, listed_species, by='Common_Name_upper')

#common names column
for(i in 1:length(marfis_poly_SAR_list)){
  marfis_spec<-marfis_SAR_master %>% filter(Common_Name_upper %in% marfis_poly_SAR_list[i])
  set_count<-length(unique(marfis_spec$LOGEFRTSID))
  marfis_setcounttable[i,1]<-marfis_poly_SAR_list[i]
  marfis_setcounttable[i,6]<-set_count
}

marfis_setcounttable<- marfis_setcounttable %>% rename(Common_Name_upper=Common_Name)
marfis_setcounttable2<-merge(marfis_setcounttable, listed_species, by='Common_Name_upper')
col_order<-c("Scientific_Name", "Common_Name", "Schedule.status","COSEWIC.status", "Wild_Species", "Set_Occurence", "Set_Frequency")
marfis_setcounttable3<-marfis_setcounttable2[,col_order]

#Count sets
Total_sets<-length(unique(marfis_intersect$LOGEFRTSID))
}
```

```{r}
marfis_set_summary_table<-data.frame(Sets_recorded_in_polygon="", Organisms_recorded_in_polygon="", Listed_organisms_recorded_in_polygon="")
marfis_set_summary_table[1,1]<-Total_sets
marfis_set_summary_table[1,2]<-Total_number_records_marfis
marfis_set_summary_table[1,3]<-Total_number_SAR_records_marfis

```

```{r}
kable(marfis_set_summary_table, align="c") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
marfis_setcounttable4<-mutate(marfis_setcounttable3, Set_Frequency=format(round((Set_Occurence/Total_sets)*100,1), nsmall=1))
marfis_setcounttable5<- marfis_setcounttable4 %>% rename(
                                     SARA_listing=Schedule.status,
                                     COSEWIC_listing=COSEWIC.status,
                                     Wild_Species_listing=Wild_Species,
                                     Set_occurence=Set_Occurence,
                                     Set_frequency=Set_Frequency
                                     )

```
 **Table 2:** MARFIS observation records of Species at Risk contained within the provided polygon. Data is summarized by species or species group.

```{r}
kable(marfis_setcounttable5, align="l") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

**Note:** A complete list of MARFIS observation records of all species within the provided polygon can be found in the Appendix.


The map below shows the location of samples recorded in the MARFIS and ISDB databases (tables above summarize records per species or species group). Map below is for internal DFO use only (rule of five was not applied). Please read the "resources and sources of uncertainty" section for additional information. 

```{r Fig 3 MARFIS and ISDB records, fig.height=8, fig.width=11}
site_map(PEZ_poly,PEZ_poly_st,site_sf,land_sf,2)+
  geom_point(data = isdb_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")+
  geom_point(data = marfis_sites, aes(x = longitude, y = latitude), size = 3, 
        shape = 16, fill = "black")

```

### **Whale Sightings Database (WSDB)**

The Marine Mammal and Pelagic Animals or Whale Sighting Database (WSDB) was
implemented in 2002 by the Department of Fisheries and Oceans (DFO) to provide a
central repository for opportunistic sightings of marine animals and to improve
accessibility to data from surveys and research activities conducted in the Bay of Fundy and on the Scotian Shelf (MacDonald et al 2017). Most sightings are collected on an opportunistic basis and observations may come from individuals with a variety of expertise in marine mammal identification experiences. Most data is gathered from platforms of opportunity that were vessel-based. Please read the Important Disclaimers for WSDB in the section below. For more information see <https://waves-vagues.dfo-mpo.gc.ca/Library/40642999.pdf> or contact <XMARWhaleSightings@dfo-mpo.gc.ca>

Map below includes SARA and COSEWIC species within the search area. Absence of a species in the map should be interpreted as an absence of reporting, not as an absence of the species in the area (e.g. sightings information underrepresents presence of cetaceans as this search does not include acoustic detections). 

```{r read wsdb and filter SARA & COSEWIC cetacean spp, echo=FALSE, include=FALSE, cache=FALSE}
wsdb <- read.csv(wsdbFile)
wsdb <- wsdb[which(wsdb$YEAR>=minYear),]
#wsdb <- remove_landPoints(wsdb,land) # work in progress
wsdb_filter <- filter_wsdb(wsdb)
```
```{r Fig 4 Whale Sightings Database, fig.height=8, fig.width=11}
par(mfrow = c(1,2), mar=c(0, 0, 5.5, 0) + 2)#it goes c(bottom, left, top, right)
#par(mar = c(5.1, 4.1, 4.1, 2.1))
site_map_old(PEZ_poly,site,land,5)
plot_wsdb(PEZ_poly,wsdb_filter,5)

```

### **North Atlantic Right Whale Consortium (NARWC) Database**

The North Atlantic right whale consortium (NARWC) databases <https://www.narwc.org/narwc-databases.html> were established in 1986 as part of a cooperative right whale research program conducted by the University of Rhode Island, New England Aquarium, Center for Coastal Studies, Woods Hole Oceanographic Institution, and other organizations forming the North Atlantic Right Whale Consortium. The Sightings Database <https://www.narwc.org/sightings-database.html> was requested to the NARWC on October 2020 for use in this internal reporting *only*. Marine mammal SARA records in the database are summarized in this report. For more information please consult the NARWC guide for users and contributors for a comprehensive guide about this database: <https://www.narwc.org/uploads/1/1/6/6/116623219/narwc_users_guide__v_6_.pdf>

```{r read narwc and filter SARA & COSEWIC cetacean spp, echo=FALSE, include=FALSE, cache=FALSE}
narwc <- read.csv(narwcFile)
narwc <- narwc[which(narwc$YEAR>=minYear),]
narwc_filter <- filter_narwc(narwc)
```
```{r Fig 5 NARWC Database, fig.height=8, fig.width=11}
par(mfrow = c(1,2), mar=c(0, 0, 5.5, 0) + 2)#it goes c(bottom, left, top, right)
site_map_old(PEZ_poly,site,land,5)
plot_narwc(PEZ_poly,narwc_filter,5)
```

### **OBIS, GBIF and iNaturalist**

REMI DAIGLE

Ocean Biogeographic Information System (OBIS; http://www.iobis.org/)
Global Biodiversity Information Facility (GBIF; https://www.gbif.org/)
iNaturalist (https://www.inaturalist.org/)

```{r, echo=FALSE, include=FALSE, cache=FALSE}
#obis$database <- "obis"
#obis_df<-as.data.frame(obis)
#df_to_shp(df= obis, file = obis, lat.field = "LATITUDE",lon.field = "LONGITUDE")
#obis_shp <- st_read("C:/Users/puncherg/Documents/NLP/Data/NaturalResources/Species/OBIS_CBIF_iNaturalist/obis2.shp", quiet=TRUE)
#obis_intersect <- st_intersection(obis_shp,PEZ_poly_st)

#x<-as.numeric(nrow(obis_intersect))
#Species<-obis_intersect$scntfcN
#obis_intersect_freq <- aggregate(
#      x = list(Records = obis_intersect$scntfcN),
#      by = list(Species = obis_intersect$scntfcN
#      ),
#      length
#      )
#obis_freq <- obis_freq[order(-obis_freq$Records),]
#Total_number_records_obis<-sum(obis_freq$Records)
#```

#```{r} 
#kable(as.data.frame(Total_number_records_obis), digits=2, full_width = F, position = "left")
#``` 
#
#```{r} 
#table with scientific names of species and number of records
#obispoly_SAR_records<-obis_intersect_freq %>% select(Species) %>% filter (Species %in% MARSAR_sci_low)

#list of SAR species in polygon
#obispoly_SAR_list<-obispoly_SAR_records$Species

#build table with rows containing sets in which SARs were captured 
#obis_setcounttable<-data.frame(COMMON_NAME="", SPECIES="", Ind_Count=0, Set_Occurence=0, Set_Frequency=0)

#obispoly_filter_sets<-obis_intersect %>% filter(Species %in% obispoly_SAR_list)
#for(i in 1:length(obispoly_SAR_list)){
#  obis_spec<-obis_intersect %>% filter(Species %in% obispoly_SAR_list[i])
#  set_count<-length(unique(obis_spec$day))
#  obis_setcounttable[i,2]<-obispoly_SAR_list[i]
#  obis_setcounttable[i,4]<-set_count
#}

#print(obis_setcounttable)
#
#obispoly_SAR_list_com<-obispoly_SAR_records$CommonName
#for(i in 1:length(obispoly_SAR_list_com)){
#  obis_com<-obis_intersect %>% filter(COMM %in% obispoly_SAR_list_com[i])
#  set_count<-length(unique(obis_com$SETNO))
#  setcounttable[i,1]<-obispoly_SAR_list_com[i]
#}
#
#obispoly_SAR_list_rec<-obispoly_SAR_records$Records
#for(i in 1:length(obispoly_SAR_list_rec)){
#  obis_com<-rv_intersect %>% filter(COMM %in% obispoly_SAR_list_rec[i])
#  set_count<-length(unique(obis_com$SETNO))
#  setcounttable[i,3]<-obispoly_SAR_list_rec[i]
#}
#
#setcounttabledf<-as.data.frame(setcounttable)
#
##Count sets
#Total_sets<-length(unique(obis_intersect$SETNO))
#setcounttable2<-mutate(setcounttabledf, Set_Frequency=format(round((Set_Occurence/Total_sets)*100,2), nsmall=2))

#```

#```{r}
#kable(obis_setcounttable, align="l") %>%
#  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
#```
#
#```{r}
#kable(obis_freq) %>%
#  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
#```
#Map below shows the location of sets performed in the Ecosystem RV Survey database (records for all sets displayed #are summarized in the table above). The yellow polygon shows the locations of the human activity. The blue polygon #displays the area searched and summarized in this report. 
#
#```{r Fig X OBIS_iNaturalist Survey records, fig.height=8, fig.width=11}
#site_map(PEZ_poly,site,land,2)
#points(obis_intersect$LONGITU,obis_intersect$LATITUD, col="black",pch=16,cex=1.5)
#
```

**Table 3:** OBIS records of Species at Risk contained within the provided polygon. Data is summarized by species or species group.


## **Open Data**

As part of its Open Government initiative, the Canadian Federal Government is committed to increasing the availability of scientific data and publications. DFO continues to support this objective by making scientific data available publically on the open government data portals in the machine-readable, simple to access, and convenient formats. Records summarized below have been published and maintained by DFO on Open Data and are available for download. For more information on open data please visit <https://open.canada.ca/en>.


### **Ecosystem Research Vessel Survey**

Fisheries and Oceans Canada (DFO) has conducted Research Vessel (RV) surveys in the Maritimes Region using a standardized protocol. For more information see <https://waves-vagues.dfo-mpo.gc.ca/Library/4062092x.pdf>. The search of the Ecosystem RV Survey database resulted in the Table below that summarizes records by species or species group. 

```{r, echo=FALSE, include=FALSE, cache=FALSE}
#still working to provide multiple data sources for locations and seasons (Summer, spring and fall surveys)
#the following is specialized for this location.
rv_OD_shp <- st_read("../../../Data/mar.wrangling/RVSurvey_OpenData/SUMMER_2020.shp", quiet=TRUE)
rv_OD <- read.csv("../../../Data/mar.wrangling/RVSurvey_OpenData/SUMMER_2020_summary.csv")
m <-merge(rv_OD_shp, rv_OD, by='SETNO')
RVsf<-st_as_sf(m)

#subbing in Gully for temporary demo purposes.
#Gully<-st_read("../../../Data/Zones/SearchPEZpolygons/PEZ_TestGullyPolygon.shp")
#rv_intersect <- st_intersection(RVsf,Gully)

rv_intersect <- st_intersection(RVsf,PEZ_poly_st)

x<-as.numeric(nrow(rv_intersect))
CommonName<-rv_intersect$COMM
Species<-rv_intersect$SPEC_GS

rv_intersect_freq <- aggregate(
  x = list(Records = rv_intersect$COMM),
  by = list(Species = rv_intersect$COMM),
  length)

rv_intersect_freq <- aggregate(
  x = list(Records = rv_intersect$COMM),
  by = list(CommonName = rv_intersect$COMM, Species = rv_intersect$SPEC.GSSPECIES),
  length)

rv_intersect_freq <- rv_intersect_freq[order(-rv_intersect_freq$Records),]
rownames(rv_intersect_freq) <- c()

Total_number_records_RV_OD <- sum(rv_intersect_freq$Records)
```

```{r}
kable(as.data.frame(Total_number_records_RV_OD, digits=2, full_width = F, position = "left"))
```

```{r}
#table with scientific names of species and number of records
RVpoly_SAR_records<-rv_intersect_freq %>% select(CommonName, Species, Records) %>% filter (Species %in% MARSAR_sci_up)
#list of SAR species in polygon
RVpoly_SAR_list<-RVpoly_SAR_records$Species

#build table with rows containing sets in which SARs were captured 
setcounttable<-data.frame(COMMON_NAME="", SPECIES="", Ind_Count=0, Set_Occurence=0, Set_Frequency=0)

RVpoly_filter_sets<-rv_intersect %>% filter(SPEC.GSSPECIES %in% RVpoly_SAR_list)
for(i in 1:length(RVpoly_SAR_list)){
  rv_spec<-rv_intersect %>% filter(SPEC.GSSPECIES %in% RVpoly_SAR_list[i])
  set_count<-length(unique(rv_spec$SETNO))
  setcounttable[i,2]<-RVpoly_SAR_list[i]
  setcounttable[i,4]<-set_count
}

RVpoly_SAR_list_com<-RVpoly_SAR_records$CommonName
for(i in 1:length(RVpoly_SAR_list_com)){
  rv_com<-rv_intersect %>% filter(COMM %in% RVpoly_SAR_list_com[i])
  set_count<-length(unique(rv_com$SETNO))
  setcounttable[i,1]<-RVpoly_SAR_list_com[i]
}

RVpoly_SAR_list_rec<-RVpoly_SAR_records$Records
for(i in 1:length(RVpoly_SAR_list_rec)){
  rv_com<-rv_intersect %>% filter(COMM %in% RVpoly_SAR_list_rec[i])
  set_count<-length(unique(rv_com$SETNO))
  setcounttable[i,3]<-RVpoly_SAR_list_rec[i]
}

setcounttabledf<-as.data.frame(setcounttable)

#Count sets
Total_sets<-length(unique(rv_intersect$SETNO))
setcounttable2<-mutate(setcounttabledf, Set_Frequency=format(round((Set_Occurence/Total_sets)*100,2), nsmall=2))

```

**Table 4:** RV Survey records of Species at Risk contained within the provided polygon. Data is summarized by species or species group.

```{r}
kable(setcounttable2, align="l") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

Map below shows the location of sets performed in the Ecosystem RV Survey database (records for all sets displayed are summarized in the table above). The yellow polygon shows the locations of the human activity. The blue polygon displays the area searched and summarized in this report. 

```{r Fig 2 Ecosystem RV Survey records with polygon, fig.height=8, fig.width=11}
<<<<<<< HEAD
site_map_old(PEZ_poly,site,land,2)
=======
site_map(PEZ_poly,site,land,2)
>>>>>>> 4d47e1604babbd973a5b20f7d267ac54f0fc0ebf
points(rv_intersect$SLONG.x,rv_intersect$SLAT.x, col="darkgreen",pch=16,cex=1)
points(rv_intersect$ELONG.x,rv_intersect$ELAT.x, col="firebrick4",pch=16,cex=1)
all_pairs<-as.data.frame(unique(cbind(rv_intersect$SLONG.x,rv_intersect$SLAT.x,rv_intersect$ELONG.x,rv_intersect$ELAT.x)))
for (i in 1:nrow(all_pairs)){
  arrows(all_pairs[i,1],all_pairs[i,2],all_pairs[i,3],all_pairs[i,4], length=0.08, angle=20, lwd=2, col="black")
}
```

### **Fisheries and Oceans Canada Species at Risk Distribution (Range) **

<https://open.canada.ca/data/en/dataset/e0fabad5-9379-4077-87b9-5705f28c490b>

The Species at Risk (SAR) Program is responsible for carrying out DFO’s mandate under the Species at Risk Act (SARA) to protect, recover and conserve all listed aquatic SAR in Canada. As part of this mandate, this spatial database has been developed to identify areas in which aquatic species listed under SARA may be found. 

Distribution and range information are identified for species listed as Endangered, Threatened or Special Concern under SARA. 

Distribution (range) polygons and lines were assembled by regional SARA biologists using the best available information, including COSEWIC status reports, recovery potential assessments, academic literature, and expert opinion. These spatial data support the protection, recovery and conservation of species listed as Endangered, Threatened or Special Concern under SARA. Species distributions are also described and displayed in Recovery Strategies, Action Plans and/or Management Plans. 

Discrepancies may exist between the distribution data shown in a species’ SARA recovery document and the current spatial data. Please contact DFO for more information on any data discrepancies.

COSEWIC and WildSpecies listed status are also provided in the table below. 

```{r Set up paths for SAR distribution files, echo=FALSE, include=FALSE, cache=FALSE}
#Re-load polygon of PEZ using the st_read function.
#PEZ_poly_st <- st_read(file.path(polyPath,pl[grep(paste0("PEZ_",AquaSiteName,PEZversion),pl)]), quiet=TRUE)
#sardist<-st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/Distribution_FGP_fixed_clipped.shp", quiet=TRUE)
#sardist_4326 <- st_transform(sardist, crs = 4326)
#st_write(sardist_4326, "../../../Data/NaturalResources/Species/SpeciesAtRisk/sardist_4326.shp")
sardist<-st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/sardist_4326.shp", quiet=TRUE)

```

```{r echo=FALSE, results='asis'}
intersect_dist <- st_intersection(sardist,PEZ_poly_st)
x<-as.numeric(nrow(intersect_dist))
intersect_dist$Common_Nam[intersect_dist$Common_Nam == "Sowerby`s Beaked Whale"] <- "Sowerby's Beaked Whale"
Common_Name<-intersect_dist$Common_Nam
Scientific_Name<-intersect_dist$Scientific
Population<-intersect_dist$Population
Area<-intersect_dist$Waterbody
intersect_dist_df<-as.data.frame(cbind(Common_Name, Scientific_Name, Population, Area))

#append columns from listed species 
dist_table<-merge(intersect_dist_df, listed_species, by='Scientific_Name')
dist_table2<-dist_table %>% 
  transmute(Common_Name, Scientific_Name, Population, Area, Schedule.status, COSEWIC.status, Wild_Species)
dist_table3<- dist_table2 %>% rename(SARA_listing=Schedule.status,
                                     COSEWIC_listing=COSEWIC.status,
                                     Wild_Species_listing=Wild_Species 
                                     )

Query_output_dist<-if(x < 1){
  "The provided polygon does not overlap with species at risk distribution range."
} else {
  "The provided polygon overlaps with species at risk distribution range."
}

Query_output_dist2<-noquote(Query_output_dist)

writeLines(c(Query_output_dist2), sep = "\n")
```

**Table 5:** Species at Risk for which the provided polygon overlaps with their distribution.

```{r echo=FALSE, results='asis'}
Query_output_table<-if(x < 1){
  ""
} else {
  kable(dist_table3[!duplicated(dist_table3),]) %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
  
}

Query_output_table

```

### **Species At Risk Critical Habitat**

Critical habitat data retrieved from https://open.canada.ca/data/en/dataset/db177a8c-5d7d-49eb-8290-31e6a45d786c

```{r Set up paths for Crithab files, echo=FALSE, include=FALSE, cache=FALSE}
ClippedCritHab <- st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/ClipCritHab.shp", quiet=TRUE)

```

```{r echo=FALSE, results='asis'}
intersect <- st_intersection(ClippedCritHab,PEZ_poly_st)
x<-as.numeric(nrow(intersect))
CommonName<-intersect$Common_Nam
Population<-intersect$Population
Area<-intersect$Waterbody
SARA_status<-intersect$SARA_Statu
intersect_df<-data.table(expand.grid(CommonName = CommonName, Population = Population, Area=Area, SARA_status=SARA_status))
Query_output_crit<-if(x < 1){
  "The provided polygon does not overlap with defined critical habitat"
} else {
  "The provided polygon overlaps with Critical Habitat"
}

Query_output_crit2<-noquote(Query_output_crit)

writeLines(c(Query_output_crit2), sep = "\n")
```
```{r echo=FALSE, results='asis'}
Query_output_table<-if(x < 1){
  ""
} else {
  kable(intersect_df[!duplicated(intersect_df),]) %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

}

Query_output_table2<-noquote(Query_output_table)
Query_output_table2


```

```{r read for crithab , echo=FALSE, include=FALSE, cache=FALSE}
source("plot_crithab.R")
```

```{r Fig X PEZ polygon with all maritime Critical Habitat polygons, fig.height=8, fig.width=11}
plot_crithab(ClippedCritHab, PEZ_poly_st, land_sf)

```

```{r read for zoom , echo=FALSE, include=FALSE, cache=FALSE}
source("plot_crithab_zoom.R")
```

```{r Fig X close up of PEZ polygon, fig.height=8, fig.width=11}
plot_crithab_zoom(ClippedCritHab, PEZ_poly_st, land_sf)
```

### **Priority Areas to Enhance Monitoring of Cetaceans**

Report: <https://waves-vagues.dfo-mpo.gc.ca/Library/40869155.pdf>

Data: <https://open.canada.ca/data/en/dataset/c094782e-0d6f-4cc0-b5a3-58908493a433>

The report and open data link have all the appropriate caveats and metadata. Any data products that may be displayed should include links to the report and open data record. 

Important disclaimers:

-	Habitats with high suitability are to be interpreted as areas where cetacean monitoring efforts may be prioritized, and results can help direct future survey efforts.
-	Due to the many reasons listed in the discussion section of the tech report (https://waves-vagues.dfo-mpo.gc.ca/Library/40869155.pdf), these cetacean modelling outputs do not represent a complete and current distribution of cetaceans in the region. They represent priority areas to direct cetacean monitoring efforts. Their use in marine spatial planning processes should be accompanied by complimentary approaches such as acoustic and visual validation of the SDM results as well as additional monitoring and modeling efforts. For example, important habitat for blue whales (provide link to that open data record) in the Northwest Atlantic was identified using a combination of approaches related to blue whale distribution and krill aggregation (observed or predicted) (Plourde et al. 2016, Lesage et al. 2018, Moors-Murphy et. al 2019), including the SDM approach described in this report. Consequently, SDM predictions presented in this report should not be used on their own. Rather, outputs should be used together with other sources of information (such as: prey distribution, tagging data, detections from acoustic monitoring, other data on cetacean occurrence, and other modeling efforts already available for the area) to delineate important habitat or for decision making. The use of multiple sources of information in Lesage et al. (2018), in addition to SDM predictions, represents a good framework in which to properly use the outputs of this report in marine spatial planning processes. 
Additional information, also provided in the open data record, is below:

-	Species Distribution Models (SDM) were used to predict and identify priority areas for enhanced monitoring of cetaceans in eastern Canadian waters off Nova Scotia, Newfoundland and Labrador. This data set represents information presented in Gomez et al. (2020) and includes sighting records and SDM outputs for ten cetacean species with sufficient records (n > 450) and sightings only for an additional six species. For more information about sighting records including which were included in each SDM, please see Gomez et al. 2020.
-	This study used a compilation of aerial- and vessel-based cetacean sightings data from 1975-2015 assembled in Gomez et al. (2017) from variety of sources. Note that sightings data from many of these sources are not effort-corrected and apparent distribution patterns based on these opportunistic sightings data are biased by when and where survey activities were conducted. Unfavorable weather and reduced visual effort in winter, spring, and autumn likely account for the fewer sighting records in these seasons compared to summer. The dataset does not include dead animal, stranding, entanglement or entrapment data. While some of the databases include records obtained during the whaling period (catches or sightings recorded prior to 1975), for all analyses/modelling conducted in this study, only sightings of free-swimming whales obtained during the post-whaling period (1975-2015) were used. Quality control checks included discarding all records outside of our study area and removing redundant records (identical species, day, month, latitude and longitude).The data used do not reflect any updates or corrections to the databases that have occurred since the data were compiled in 2016. Sightings are not available for download here, please contact the original data sources listed below to obtain raw sightings data.
-	This study represents an important initiative in eastern Canada to highlight key areas for cetacean monitoring in waters off Nova Scotia, Newfoundland and Labrador. Habitats with high suitability are interpreted as areas where cetacean monitoring efforts may be prioritized, and results can help direct future survey efforts. These model outputs used cetacean sightings from several decades and dynamic environmental predictors that used seasonal averages across multiple years. As proxies for prey availability, five predictor environmental variables were selected for the SDM: ocean depth, compound topographic index, sea surface temperature, areas of persistently high chlorophyll-a concentration, and regional chlorophyll-a magnitude. See Gomez et al. (2020) for further details on modelling methods. Persistent patterns over time (between 1975-2015) are the main patterns expected to be captured by these models. Further, SDM results presented here are not the same as species density maps; rather, they portray predicted suitable habitat based on environmental characteristics and sightings data that were not always derived from effort-based surveys. Consequently, the use of these models in marine spatial planning processes should be accompanied by complimentary approaches such as acoustic and visual validation of the SDM results as well as additional monitoring and modeling efforts. Please refer to Gomez et al. (2020) for examples on how to best use these data outputs. Future efforts will focus on using more recent data and improving these models to facilitate the inclusion of cetaceans in marine spatial planning processes that are currently underway.
Data sources:
-	Fisheries and Oceans Canada Maritimes region and Newfoundland and Labrador region (Whale Sightings Database, Ocean and Ecosystem Sciences Division, Dartmouth, NS; http://www.inter.dfo-mpo.gc.ca/Maritimes/SABS/popec/sara/Database, MacDonald et. al. 2017)
-	Ocean Biogeographic Information System (OBIS; http://www.iobis.org/),
-	North Atlantic Right Whale Consortium (NARWC; http://www.narwc.org/)
-	Whitehead Lab at Dalhousie University (http://whitelab.biology.dal.ca/)
-	Environment and Climate Change Canada’s (Canadian Wildlife Service) Eastern Canada Seabirds at Sea (ECSAS) program (Gjerdrum et al. 2012).

Associated publication: Gomez, C., Konrad, C.M., Vanderlaan, A., Moors-Murphy, H.B., Marotte, E., Lawson, J., Kouwenberg, A-L., Fuentes-Yaco, C., Buren, A. 2020. Identifying priority areas to enhance monitoring of cetaceans in the Northwest Atlantic Ocean. Can. Tech. Rep.Fish. Aquat. Sci. 3370: vi + 103 p. http://waves-vagues.dfo-mpo.gc.ca/Library/40869155.pdf

```{r Set up paths for Priority Areas to Enhance Monitoring of Cetaceans files, echo=FALSE, include=FALSE, cache=FALSE}
#convert fin whale raster to sf object
fin_whale<- raster("../../../Data/NaturalResources/Species/Cetaceans/PriorityAreas_FGP/Fin_Whale.tif")
fin_whale[fin_whale==0] <- NA
fin_whale_sf<-st_as_stars(fin_whale)%>%st_as_sf()
#convert harbour porpoise raster to sf object
harbour_porpoise<- raster("../../../Data/NaturalResources/Species/Cetaceans/PriorityAreas_FGP/Harbour_Porpoise.tif")
harbour_porpoise[harbour_porpoise==0] <- NA
harbour_porpoise_sf<-st_as_stars(harbour_porpoise)%>%st_as_sf()
#convert humpback whale raster to sf object
humpback_whale<- raster("../../../Data/NaturalResources/Species/Cetaceans/PriorityAreas_FGP/Humpback_Whale.tif")
humpback_whale[humpback_whale==0] <- NA
humpback_whale_sf<-st_as_stars(humpback_whale)%>%st_as_sf()
#convert sei whale raster to sf object
sei_whale<- raster("../../../Data/NaturalResources/Species/Cetaceans/PriorityAreas_FGP/Sei_Whale.tif")
sei_whale[sei_whale==0] <- NA
sei_whale_sf<-st_as_stars(sei_whale)%>%st_as_sf()

```

```{r read functions for Priority Areas to Enhance Monitoring of Cetaceans overlap assessment, echo=FALSE, include=FALSE, cache=FALSE}
source("cetacean_priority_areas.R")
```

```{r echo=FALSE, results='asis'}
#function for overlap
fin_area<-fin_overlap(fin_whale_sf, PEZ_poly_st)
harbour_area<-harbour_overlap(harbour_porpoise_sf, PEZ_poly_st)
humpback_area<-humpback_overlap(humpback_whale_sf, PEZ_poly_st)
sei_area<-sei_overlap(sei_whale_sf, PEZ_poly_st)
cetacean_matrix<-data.frame(Fin_Whale="",Habour_Porpoise="", Humpback_Whale="", Sei_Whale="")
cetacean_matrix[1,1]<-fin_area
cetacean_matrix[1,2]<-harbour_area
cetacean_matrix[1,3]<-humpback_area
cetacean_matrix[1,4]<-sei_area

```

**Table 6:** Results showing if the provided polygon overlaps with areas defined as Priority Areas to Enhance Monitoring of several species of cetaceans (Fin whale, Harbour Porpoise, Humpback Whale and Sei Whale). TRUE = polygon does overlap with priority area; TRUE = polygon does NOT overlap with priority area.

```{r}
kable(cetacean_matrix, align="c") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r read for priority areas for cetaceans, echo=FALSE, include=FALSE, cache=FALSE}
source("plot_cetaceans_4grid.R")
```

```{r Fig X priority areas for cetaceans, fig.height=8, fig.width=11}
plot_cetaceans_4grid(fin_whale_sf, harbour_porpoise_sf, humpback_whale_sf, sei_whale_sf, PEZ_poly_st, land_sf)
```





### **Blue Whale Important Habitat**

<https://open.canada.ca/data/en/dataset/8fafd919-fcbe-43a3-a911-3d9461273441>

```{r Set up paths for blue whale habitat files, echo=FALSE, include=FALSE, cache=FALSE}
Blue_32198 <- st_read("../../../Data/NaturalResources/Species/Cetaceans/BlueWhaleHabitat_FGP/BlueWhaleHabitat_HabitatBaleineBleue.shp", quiet=TRUE)
Blue_4326 <- st_transform(Blue_32198, crs = 4326)
Blue_4326b<-setNames(Blue_4326, replace(names(Blue_4326), names(Blue_4326) == 'activité', 'activite'))
```

```{r read functions for bw_habitat overlap assessment, echo=FALSE, include=FALSE, cache=FALSE}
source("Blue_Whale_habitat.R")
```

```{r echo=FALSE, results='asis'}
#function for overlap
blue_whale_habitat_overlap(Blue_Whale_shp=Blue_4326b, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for sector
blue_whale_habitat_sector(Blue_Whale_shp=Blue_4326b, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for activity
blue_whale_habitat_activity(Blue_Whale_shp=Blue_4326b, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for months
blue_whale_habitat_months(Blue_Whale_shp=Blue_4326, PEZ_poly_st= PEZ_poly_st)
```

NOTE: Colour code polygons for different activities.

```{r read for bw habitat in maritime region, echo=FALSE, include=FALSE, cache=FALSE}
source("plot_bw_hab.R")
```

```{r Fig X PEZ polygon with all maritime blue whale habitat polygons, fig.height=8, fig.width=11}
plot_bw_hab(Blue_4326, PEZ_poly_st, land_sf)

```

```{r read for zoom of bw habitat, echo=FALSE, include=FALSE, cache=FALSE}
source("plot_bw_hab_zoom.R")
```

```{r Fig X close up of PEZ polygon and bw habitat, fig.height=8, fig.width=11}
plot_bw_hab_zoom(Blue_4326, PEZ_poly_st, land_sf)
```

### **Draft: Leatherback Sea Turtle Important Habitat**

```{r Set up paths for leatherback turtle files, echo=FALSE, include=FALSE, cache=FALSE}
leatherback_shp <- st_read("../../../Data/NaturalResources/Species/SpeciesAtRisk/LeatherBackTurtleCriticalHabitat/LBT_CH_2013.shp", quiet=TRUE)
```

```{r read functions for leatherback_habitat overlap assessment, echo=FALSE, include=FALSE, cache=FALSE}
source("leatherback.R")
```

```{r echo=FALSE, results='asis'}
#function for overlap
leatherback_overlap(leatherback_shp=leatherback_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for sector
leatherback_area(leatherback_shp=leatherback_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r read for leatherback , echo=FALSE, include=FALSE, cache=FALSE}
source("plot_leatherback.R")
```

```{r Fig X PEZ polygon with all maritime leatherback polygons, fig.height=8, fig.width=11}
plot_leatherback(leatherback_shp, PEZ_poly_st, land_sf)
```

### **Ecologically and Biologically Significant Areas (EBSA)**

```{r Set up paths for Ecologically and Biologically Significant Areas (EBSA) files, echo=FALSE, include=FALSE, cache=FALSE}
EBSA <- st_read("../../../Data/Zones/DFO_EBSA/DFO_EBSA.shp", quiet=TRUE)
EBSA_shp <- st_transform(EBSA, crs = 4326)
```

```{r read functions for EBSA overlap assessment, echo=FALSE, include=FALSE, cache=FALSE}
source("EBSA.R")
```

```{r echo=FALSE, results='asis'}
#function for overlap
EBSA_overlap(EBSA_shp=EBSA_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for report
EBSA_report(EBSA_shp=EBSA_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for report url
EBSA_reporturl(EBSA_shp=EBSA_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for location
EBSA_location(EBSA_shp=EBSA_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r echo=FALSE, results='asis'}
#function for bioregion
EBSA_bioregion(EBSA_shp=EBSA_shp, PEZ_poly_st= PEZ_poly_st)
```

```{r read for EBSA , echo=FALSE, include=FALSE, cache=FALSE}
source("plot_EBSA.R")
```

```{r Fig X PEZ polygon with all maritime EBSA polygons, fig.height=8, fig.width=11}
plot_EBSA(EBSA_shp, PEZ_poly_st, land_sf)
```


#### **For information about seabirds please contact Environment and Climate Change Canada. Link: **

<https://open.canada.ca/data/en/dataset/f612e2b4-5c67-46dc-9a84-1154c649ab4e>

## **Databases yet to be included**

#### **Intertidal vegetation maps derived from remote sensing.**

#### **Ecosystem Management interactive ArcGIS maps**

-developed for 1) Regulatory Review projects and 2) SAR program. Currently, maps are for internal use only by Maritimes SARP.

#### **Province's data is openx**

(https://data.novascotia.ca/w/jgyj-d4fh/default?cur=8JS4clBZaD9&from=l6_um6e8ufx)

#### **Tracking data, OTN**

(https://obis.org/dataset/80997ac3-87cb-411c-ab1f-334adec45050) via ERDDAP and R package rerddap

#### **Electrofishing**

(Jeremy Bloome)

#### **eDNA**

#### **Lobster and scallop programs**

#### **Salmon**


# **Resources and Sources of Uncertainty**

Coastal and offshore areas of the Scotian Shelf bioregion are generally not adequately sampled, and hence information on these space and time scales is generally not contained within the various data sources available to DFO, including the surveys referred to in this document. Therefore, there is uncertainty as to the exact distribution of species in the search.

### **Important Disclaimers for ISDB and MARFIS**

MARFIS and ISDB do not fully sample the region spatially or temporally and, therefore, additional information on presence and habitat use (i.e. spawning, migration, feeding) must be drawn from larger-scale studies. 

Please remember that fisheries catch and effort information:
1.         for an individual licence holder is considered personal information and is protected under section 19 of the Access to Information Act <https://laws-lois.justice.gc.ca/eng/acts/a-1/page-5.html#h-12>. 
2.         for a corporate licence holder is considered to be sensitive, proprietary information and protected under Section 20 of the Access to Information Act <https://laws-lois.justice.gc.ca/eng/acts/a-1/page-5.html#h-13>.  
Without written consent, DFO is not permitted to release information or data products (e.g., maps and data layers) that might reveal personal or third party information such as catch, landed values, and vessel-specific fishing locations.  All of this is spelled out to DFO staff here - Informal Release Guidelines (i.e. Appendix B – “Catch and Effort and Quota Information: Do’s and Don’ts for Informal Release” <\\ent.dfo-mpo.ca\ATLShares\Shared\ATIP Information\Informal_Release_Guidelines-eng.docx>).

The reproducible reporting tool is for internal use only. Please do not release data you should not. If in doubt, check with your supervisor.

Should you receive a request for set-level Observer data (ISDB) and MARFIS, please just forward to Peter Comeau and <XMARComData@dfo-mpo.gc.ca>, respectively. Please feel free to use the email template below. Note that the template includes an attachment which you can download here - Informal Release Guidelines <\\ent.dfo-mpo.ca\ATLShares\Shared\ATIP Information\Informal_Release_Guidelines-eng.docx>. If you are including observer data in a publication, please remember to aggregate it. If you need help doing so, Mike McMahon has a handy R script that can help you. Ask him - he loves to talk about his scripts. 

TLDR; Please do not share set-level observer data (ISDB) and MARFIS with external (non-DFO) people.  

Hi,

I apologize, but we can not provide you with the level of detail as it has been requested.  Fisheries catch and effort information for an individual licence holder is considered personal information and is protected under section 19 of the Access to Information Act. Fisheries catch and effort information for a corporate licence holder is considered to be sensitive, proprietary information and protected under Section 20 of the Access to Information Act.  Without written consent, DFO is not permitted to release information or data products (e.g., maps and data layers) that might reveal personal or third party information such as catch, landed values, and vessel-specific fishing locations.  All of this is spelled out to DFO staff the attached document (i.e. Appendix B – “Catch and Effort and Quota Information: Do’s and Don’ts for Informal Release”). 

It may be possible to provide you instead with an aggregated product that combines the information for at least five different licence holders, licences, or vessels.  Please feel free to contact us again if you need help modifying your request such that it meets these specifications while still being useful in answering your questions. 

### **Important Disclaimers for WSDB**

- The sighting data have not yet been completely error-checked and may contain duplicate records.

- The quality of some of the sighting data is unknown. Most sightings are collected on an opportunistic basis and observations may come from individuals with a wide range of expertise and experience in marine mammal identification. 

- Most data have been gathered from platforms of opportunity that were vessel-based. The inherent problems with negative or positive reactions by cetaceans to the approach of such vessels have not yet been factored into the data. 

- Sighting effort has not been quantified (i.e., the numbers cannot be used to estimate true species density or abundance for an area). Lack of sightings do not necessarily represent lack of species present in a particular area. 

- Significant uncertainty in the number of animals sighted per detection persists due to the difficulty of quantifying individuals among varying species-specific group sizes.

- For completeness, the data represent an amalgamation of sightings from a variety of years and seasons. Effort (and number of sightings) is not necessarily consistent among months, years, and areas. There are large gaps between years. Thus seasonal and distributional information should not be considered definitive. Note that sightings data from many of these sources are not effort-corrected and apparent distribution patterns based on these opportunistic sightings data are biased by when and where activities were conducted. Unfavorable weather and reduced visual effort in winter, spring, and autumn likely account for the fewer sighting records in these seasons compared to summer.

- Many sightings could not be identified to species, but are listed to the lowest taxonomic group possible.

### **Cetacean Information**

- Please contact the NARWC for infomration about the <https://www.narwc.org/sightings-database.html>, and please consult the NARWC guide for users and contributors:  <https://www.narwc.org/uploads/1/1/6/6/116623219/narwc_users_guide__v_6_.pdf>

- Please review the "Interpreting results for marine spatial planning purposes" section for a summary of caveats and uncertainty associated with model prediction in Gomez et al. 2020 <https://waves-vagues.dfo-mpo.gc.ca/Library/40869155.pdf>.

### **This document**

This synthesis is created using Rmarkdown and therefore this document can be reproduced and reused using the code  available in <https://github.com/AtlanticR/MSP/tree/master/SearchPEZ>. The full document can be updated rapidly as more or different information becomes available.

This document was prepared by the Science MSP Team: <Gregory.Puncher@dfo-mpo.gc.ca>, <Catalina.Gomez@dfo-mpo.gc.ca>, <Gordana.Lazin@dfo-mpo.gc.ca>, <Brian.Bower@dfo-mpo.gc.ca>, <Philip.Greyson@dfo-mpo.gc.ca>, and <Tana.Worcester@dfo-mpo.gc.ca>

###**References**

NOTE FOR DEVELOPMENT: WOULD NEED TO INCLUDE ADDITIONAL REFERENCES AND PROPER CITATIONS 

MacDonald, D., Emery, P., Themelis, D., Smedbol, R.K., Harris, L.E., and McCurdy, Q. 2017. Marine mammal and pelagic animal sightings (Whalesightings) database: a user’s guide. Can. Tech. Rep. Fish. Aquat. Sci. 3244: v + 44 p.<https://waves-vagues.dfo-mpo.gc.ca/Library/40642999.pdf> 

Kennedy R.D. 2019. The North Atlantic Right Whale Consortium Database: A Guide for Users and Contributors. Version 6. North Atlantic Right Whale Consortium Reference Document 2019-02.144 pp. <https://www.narwc.org/uploads/1/1/6/6/116623219/narwc_users_guide__v_6_.pdf> 

### **Acknowledgements**

<Mike.McMahon@dfo-mpo.gc.ca>! for providing code and advice in the use of `Mar.datawrangling`: A suite of tools for extracting, filtering and aggregating data from the Maritimes fisheries science databases <https://github.com/Maritimes/Mar.datawrangling>

The Atlantic R Learning & Development Initiative <https://github.com/AtlanticR>.  
<<<<<<< HEAD


# **Appendix**

**Table S1:** ISDB observation records contained within the polygon summarized by species or species group.

```{r}
kable(isdb_freq) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

**Table S2:** MARFIS observation records contained within the polygon summarized by species or species group.

```{r}
kable(marfis_freq) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

**Table S3:** OBIS observation records contained within the polygon summarized by species or species group.


**Table S4:** RV survey observation records contained within the polygon summarized by species or species group.

```{r}
kable(rv_intersect_freq) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
=======
>>>>>>> 4d47e1604babbd973a5b20f7d267ac54f0fc0ebf
